<div class="requests-container" role="region" aria-label="Solicitudes agendadas">
  <!-- Header -->
  <header class="requests-header" role="banner">
    <div class="header-main">
      <h1 class="header-title">üìÖ Solicitudes Agendadas</h1>
      <p class="header-subtitle">
        Revisa y gestiona tus servicios. Vista simple y clara.
      </p>
    </div>

    <div class="header-actions">
      <button class="btn btn-back" aria-label="Volver al inicio" (click)="routeMenu()">
        ‚Üê Volver al inicio
      </button>
    </div>
  </header>

  <button
    class="btn btn-refresh"
    (click)="refresh()"
    [disabled]="isRefreshing"
    [attr.aria-busy]="isRefreshing"
    title="Actualizar lista de solicitudes">
    üîÑ {{ isRefreshing ? 'Actualizando‚Ä¶' : 'Actualizar' }}
  </button>

  <small *ngIf="lastUpdated" class="last-updated">
    √öltima actualizaci√≥n: {{ lastUpdated | date:'dd/MM/yyyy, h:mm a' }}
  </small>

  <!-- Resumen -->
  <section class="summary-cards" aria-label="Resumen de estados">
    <div class="summary-card">
      <div class="summary-value">{{ summary.total | number }}</div>
      <div class="summary-label">Totales</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">{{ summary.agendados | number }}</div>
      <div class="summary-label">Agendados</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">{{ summary.completados | number }}</div>
      <div class="summary-label">Completados cliente</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">{{ summary.finalizados | number }}</div>
      <div class="summary-label">Finalizados</div>
    </div>
  </section>

  <!-- Tabla -->
  <section class="section requests-table-section" aria-label="Tabla de solicitudes">
    <h2 class="section-title">Listado</h2>

    <div class="table-wrapper" role="table" aria-label="Solicitudes">
      <div class="table-scroll">
        <table class="requests-table">
          <thead>
            <tr>
              <th scope="col">N¬∞</th>
              <th scope="col">Cliente</th>
              <th scope="col">Proveedor</th>
              <th scope="col">Fecha agendamiento</th>
              <th scope="col">Precio cobrado</th>
              <th scope="col">Fecha completado cliente</th>
              <th scope="col">Fecha finalizado</th>
              <th scope="col">Notas</th>
              <th scope="col">Estado</th>
              <th scope="col" class="col-actions" *ngIf="mostrarColumnaAcciones">Acciones</th>
            </tr>
          </thead>

          <tbody *ngIf="dataLoaded">
            <tr *ngFor="let s of solicitudes">
              <td data-label="N¬∞">{{ s.idSolicitud }}</td>
              <td data-label="Cliente">{{ s.clienteNombre }}</td>
              <td data-label="Proveedor">{{ s.proveedorNombre }}</td>
              <td data-label="Fecha agendamiento">{{ formatoFecha(s.fechaAgendamiento) }}</td>
              <td data-label="Precio cobrado">{{ formatoPrecio(s.precioAcordado) }}</td>
              <td data-label="Fecha completado cliente">{{ formatoFecha(s.fechaCreacion) }}</td>
              <td data-label="Fecha finalizado">{{ formatoFecha(s.fechaRealizacion) }}</td>
              <td data-label="Notas">{{ s.notas || '‚Äî' }}</td>
              <td data-label="Estado">
                <span class="badge" [ngClass]="{
                  'badge-agendado': s.estado === 'Agendado',
                  'badge-completado': s.estado === 'Completado',
                  'badge-finalizado': s.estado === 'Finalizado'
                }">{{ s.estado }}</span>
              </td>
              <td class="col-actions" data-label="Acciones" *ngIf="mostrarColumnaAcciones">
                <!-- CLIENTE: Completar -->
                <button *ngIf="isCliente && s.estado === 'Agendado'" 
                        class="action-chip btn-complete" 
                        (click)="onClickCompletar(s)">
                  ‚úì Completar
                </button>

                <!-- PROVEEDOR: Finalizar -->
                <button *ngIf="isProveedor && s.estado === 'Completado'" 
                        class="action-chip btn-finish" 
                        (click)="onClickFinalizar(s)">
                  ‚úî Finalizar
                </button>

                <!-- PROVEEDOR: Ver detalle -->
                <button *ngIf="isProveedor && s.estado === 'Finalizado'" 
                        class="action-chip btn-detail" 
                        (click)="abrirModalDetalle(s)">
                  üëÅÔ∏è Ver detalle
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Tarjetas m√≥viles (misma l√≥gica que la tabla) -->
      <div class="cards-mobile" *ngIf="dataLoaded">
        <article class="req-card" *ngFor="let s of solicitudes">
          <header class="req-card-header">
            <span class="req-number">N¬∞ {{ s.idSolicitud }}</span>
            <span class="badge" [ngClass]="{
              'badge-agendado': s.estado === 'Agendado',
              'badge-completado': s.estado === 'Completado',
              'badge-finalizado': s.estado === 'Finalizado'
            }">{{ s.estado }}</span>
          </header>
          <dl class="req-data">
            <div><dt>Cliente</dt><dd>{{ s.clienteNombre }}</dd></div>
            <div><dt>Proveedor</dt><dd>{{ s.proveedorNombre }}</dd></div>
            <div><dt>Agendado</dt><dd>{{ formatoFecha(s.fechaAgendamiento) }}</dd></div>
            <div><dt>Precio</dt><dd>{{ formatoPrecio(s.precioAcordado) }}</dd></div>
            <div><dt>Completado cliente</dt><dd>{{ formatoFecha(s.fechaCreacion) || '‚Äî' }}</dd></div>
            <div><dt>Finalizado</dt><dd>{{ formatoFecha(s.fechaRealizacion) || '‚Äî' }}</dd></div>
            <div class="req-notas"><dt>Notas</dt><dd>{{ s.notas || '‚Äî' }}</dd></div>
          </dl>
          <footer class="req-actions">
            <!-- CLIENTE: Completar -->
            <button *ngIf="isCliente && s.estado === 'Agendado'"
                    class="action-chip btn-complete"
                    (click)="onClickCompletar(s)">
              ‚úì Completar
            </button>

            <!-- PROVEEDOR: Finalizar -->
            <button *ngIf="isProveedor && s.estado === 'Completado'"
                    class="action-chip btn-finish"
                    (click)="onClickFinalizar(s)">
              ‚úî Finalizar
            </button>

            <!-- PROVEEDOR: Ver detalle -->
            <button *ngIf="isProveedor && s.estado === 'Finalizado'"
                    class="action-chip btn-detail"
                    (click)="abrirModalDetalle(s)">
              üëÅÔ∏è Ver detalle
            </button>
          </footer>
        </article>
      </div>
    </div>
  </section>
</div>

<!-- =================== MODAL: EVALUAR SERVICIO =================== -->
<div class="modal-backdrop" 
     [class.is-open]="modalEvaluacionAbierto"
     [attr.aria-hidden]="!modalEvaluacionAbierto">
  <div class="modal-card modal-card-evaluacion" 
       role="dialog" 
       aria-modal="true"
       aria-labelledby="titulo-evaluacion">
    
    <div class="modal-header modal-header--center">
      <h3 id="titulo-evaluacion">¬øDesea evaluar el servicio?</h3>
    </div>

    <div class="modal-body modal-body--center">
      <p class="eval-text">
        Su opini√≥n nos ayuda a mejorar.  
        ¬øQuiere evaluar ahora o prefiere hacerlo m√°s tarde?
      </p>
    </div>

    <div class="modal-footer modal-footer--stacked">
      <button class="eval-btn eval-btn-primary"
              (click)="irAEvaluacion()">
        ‚úÖ Ir a evaluar ahora
      </button>

      <button class="eval-btn eval-btn-secondary"
              (click)="posponerEvaluacion()">
        ‚è±Ô∏è M√°s tarde
      </button>
    </div>
  </div>
</div>

<!-- =================== MODAL: FINALIZAR SERVICIO (formulario) =================== -->
<div class="modal-backdrop" 
     [class.is-open]="modalAbierto" 
     [attr.aria-hidden]="!modalAbierto">
  <div class="modal-card" role="dialog">
    <div class="modal-header">
      <h3>‚úî Finalizar servicio</h3>
      <button class="modal-close" (click)="cerrarModalFinalizar()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label>Precio cobrado *</label>
          <input type="number" [(ngModel)]="precioCobrado" placeholder="$ 0" />
        </div>
        <div class="form-row">
          <label>Medio de pago *</label>
          <select [(ngModel)]="medioPago">
            <option value="" disabled selected>Selecciona medio de pago</option>
            <option>Efectivo</option>
            <option>Transferencia</option>
            <option>Tarjeta</option>
            <option>Otro</option>
          </select>
        </div>
        <div class="form-row">
          <label>Notas (opcional)</label>
          <textarea rows="3" [(ngModel)]="notas"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-chip btn-cancel" (click)="cerrarModalFinalizar()">Cancelar</button>
      <button class="action-chip btn-finish" (click)="guardarFinalizacion()">‚úî Guardar finalizaci√≥n</button>
    </div>
  </div>
</div>

<!-- =================== MODAL: VER DETALLE (solo lectura) =================== -->
<div class="modal-backdrop" 
     [class.is-open]="modalDetalleAbierto"
     [attr.aria-hidden]="!modalDetalleAbierto">
  <div class="modal-card">
    <div class="modal-header">
      <h3>üëÅÔ∏è Detalle de finalizaci√≥n</h3>
      <button class="modal-close" (click)="cerrarModalDetalle()">‚úñ</button>
    </div>
    <div class="modal-body" *ngIf="detalleSeleccionado">
      <div class="detail-grid">
        <div><span class="detail-label">N¬∞ Solicitud:</span> {{ detalleSeleccionado.idSolicitud }}</div>
        <div><span class="detail-label">Cliente:</span> {{ detalleSeleccionado.clienteNombre }}</div>
        <div><span class="detail-label">Proveedor:</span> {{ detalleSeleccionado.proveedorNombre }}</div>
        <div><span class="detail-label">Fecha finalizado:</span> {{ formatoFecha(detalleSeleccionado.fechaRealizacion) }}</div>
        <div><span class="detail-label">Precio cobrado:</span> {{ formatoPrecio(detalleSeleccionado.precioAcordado) }}</div>
        <div><span class="detail-label">Medio de pago:</span> {{ detalleSeleccionado.medioDePago || '‚Äî' }}</div>
        <div class="full"><span class="detail-label">Notas:</span> {{ detalleSeleccionado.notas || '‚Äî' }}</div>
        <div class="full"><span class="detail-label">Denuncia:</span> <span>No</span></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-chip btn-cancel" (click)="cerrarModalDetalle()">Cerrar</button>
    </div>
  </div>
</div>
