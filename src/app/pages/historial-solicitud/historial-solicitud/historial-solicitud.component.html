

<div class="requests-container" role="region" aria-label="Solicitudes agendadas">
  <!-- Header -->
  <header class="requests-header" role="banner">
    <div class="header-main">
      <h1 class="header-title">üìÖ Solicitudes Agendadas</h1>
      <p class="header-subtitle">
        Revisa y gestiona tus servicios. Vista simple y clara.
      </p>
    </div>

    <div class="header-actions">
      <button class="btn btn-back" aria-label="Volver al inicio" (click)="routeMenu()">
        ‚Üê Volver al inicio
      </button>
    </div>
  </header>

  <button
    class="btn btn-refresh"
    (click)="refresh()"
    [disabled]="isRefreshing"
    [attr.aria-busy]="isRefreshing"
    title="Actualizar lista de solicitudes">
    üîÑ {{ isRefreshing ? 'Actualizando‚Ä¶' : 'Actualizar' }}
  </button>

  <small *ngIf="lastUpdated" class="last-updated">
    √öltima actualizaci√≥n: {{ lastUpdated | date:'dd/MM/yyyy, h:mm a' }}
  </small>

  <!-- Resumen -->
  <section class="summary-cards" aria-label="Resumen de estados">
    <div class="summary-card">
      <div class="summary-value">{{ summary.total | number }}</div>
      <div class="summary-label">Totales</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">{{ summary.agendados | number }}</div>
      <div class="summary-label">Agendados</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">{{ summary.completados | number }}</div>
      <div class="summary-label">Completados cliente</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">{{ summary.finalizados | number }}</div>
      <div class="summary-label">Finalizados</div>
    </div>
  </section>

  <!-- Tabla -->
  <section class="section requests-table-section" aria-label="Tabla de solicitudes">
    <h2 class="section-title">Listado</h2>

    <div class="table-wrapper" role="table" aria-label="Solicitudes">
      <div class="table-scroll">
        <table class="requests-table">
          <thead>
            <tr>
              <th scope="col">N¬∞</th>
              <th scope="col">Cliente</th>
              <th scope="col">Proveedor</th>
              <th scope="col">Fecha agendamiento</th>
              <th scope="col">Precio cobrado</th>
              <th scope="col">Fecha completado cliente</th>
              <th scope="col">Fecha finalizado</th>
              <th scope="col">Notas</th>
              <th scope="col">Estado</th>
              <th scope="col" class="col-actions" *ngIf="mostrarColumnaAcciones">Acciones</th>
            </tr>
          </thead>

          <tbody *ngIf="dataLoaded">
            <tr *ngFor="let s of solicitudes">
              <td data-label="N¬∞">{{ s.idSolicitud }}</td>
              <td data-label="Cliente">{{ s.clienteNombre }}</td>
              <td data-label="Proveedor">{{ s.proveedorNombre }}</td>
              <td data-label="Fecha agendamiento">{{ formatoFecha(s.fechaAgendamiento) }}</td>
              <td data-label="Precio cobrado">{{ formatoPrecio(s.precioAcordado) }}</td>
              <td data-label="Fecha completado cliente">{{ formatoFecha(s.fechaCreacion) }}</td>
              <td data-label="Fecha finalizado">{{ formatoFecha(s.fechaRealizacion) }}</td>
              <td data-label="Notas">{{ s.notas || '‚Äî' }}</td>
              <td data-label="Estado">
                <span class="badge" [ngClass]="{
                  'badge-agendado': s.estado === 'Agendado',
                  'badge-completado': s.estado === 'Completado',
                  'badge-finalizado': s.estado === 'Finalizado'
                }">{{ s.estado }}</span>
              </td>
              <td class="col-actions" data-label="Acciones" *ngIf="mostrarColumnaAcciones">
                <button *ngIf="isCliente && s.estado === 'Agendado'" 
                        class="action-chip btn-complete" 
                        (click)="completar(s)">‚úì Completar</button>

                <button *ngIf="isProveedor && s.estado === 'Completado'" 
                        class="action-chip btn-finish" 
                        (click)="abrirModalFinalizar(s)">‚úî Finalizar</button>

                <button *ngIf="isProveedor && s.estado === 'Finalizado'" 
                        class="action-chip btn-detail" 
                        (click)="abrirModalDetalle(s)">üëÅÔ∏è Ver detalle</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Tarjetas m√≥viles -->
      <div class="cards-mobile">
        <!-- Agendado -->
        <article class="req-card">
          <header class="req-card-header">
            <span class="req-number">N¬∞ 000145</span>
            <span class="badge badge-agendado">Agendado</span>
          </header>
          <dl class="req-data">
            <div><dt>Cliente</dt><dd>Mar√≠a Gonz√°lez</dd></div>
            <div><dt>Proveedor</dt><dd>Juan P√©rez</dd></div>
            <div><dt>Agendado</dt><dd>12/10/2025 10:30</dd></div>
            <div><dt>Precio</dt><dd>$ 35.000</dd></div>
            <div><dt>Completado cliente</dt><dd>‚Äî</dd></div>
            <div><dt>Finalizado</dt><dd>‚Äî</dd></div>
            <div class="req-notas"><dt>Notas</dt><dd>Instalaci√≥n de l√°mparas en comedor y pasillo.</dd></div>
          </dl>
          <footer class="req-actions">
            <button class="action-chip btn-complete">‚úì Completar</button>
            <button class="action-chip btn-finish">‚úî Finalizar</button>
          </footer>
        </article>

        <!-- Completado -->
        <article class="req-card">
          <header class="req-card-header">
            <span class="req-number">N¬∞ 000150</span>
            <span class="badge badge-completado">Completado</span>
          </header>
          <dl class="req-data">
            <div><dt>Cliente</dt><dd>Ana Rojas</dd></div>
            <div><dt>Proveedor</dt><dd>ElectricPro Ltda.</dd></div>
            <div><dt>Agendado</dt><dd>14/10/2025 09:00</dd></div>
            <div><dt>Precio</dt><dd>$ 40.000</dd></div>
            <div><dt>Completado cliente</dt><dd>14/10/2025 18:00</dd></div>
            <div><dt>Finalizado</dt><dd>‚Äî</dd></div>
            <div class="req-notas"><dt>Notas</dt><dd>Revisi√≥n de enchufes y cambio de t√©rmico.</dd></div>
          </dl>
          <footer class="req-actions">
            <button class="action-chip btn-complete" disabled>‚úì Completar</button>
            <button class="action-chip btn-finish">‚úî Finalizar</button>
          </footer>
        </article>

        <!-- Finalizado -->
        <article class="req-card">
          <header class="req-card-header">
            <span class="req-number">N¬∞ 000146</span>
            <span class="badge badge-finalizado">Finalizado</span>
          </header>
          <dl class="req-data">
            <div><dt>Cliente</dt><dd>Carlos Medina</dd></div>
            <div><dt>Proveedor</dt><dd>ServiPlom SPA</dd></div>
            <div><dt>Agendado</dt><dd>09/10/2025 15:00</dd></div>
            <div><dt>Precio</dt><dd>$ 48.000</dd></div>
            <div><dt>Completado cliente</dt><dd>10/10/2025 18:20</dd></div>
            <div><dt>Finalizado</dt><dd>11/10/2025 09:05</dd></div>
            <div class="req-notas"><dt>Notas</dt><dd>Cambio de flexibles y revisi√≥n de fuga bajo lavamanos.</dd></div>
          </dl>
          <footer class="req-actions">
            <button class="action-chip btn-detail">üëÅÔ∏è Ver detalle</button>
          </footer>
        </article>
      </div>
    </div>
  </section>
</div>

<!-- =================== MODAL: FINALIZAR SERVICIO (formulario) =================== -->
<!-- Para abrir este modal agrega la clase 'is-open' en el div.modal-backdrop -->
<div class="modal-backdrop" [class.is-open]="modalAbierto" aria-hidden="!modalAbierto">
  <div class="modal-card" role="dialog">
    <div class="modal-header">
      <h3>‚úî Finalizar servicio</h3>
      <button class="modal-close" (click)="cerrarModalFinalizar()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label>Precio cobrado *</label>
          <input type="number" [(ngModel)]="precioCobrado" placeholder="$ 0" />
        </div>
        <div class="form-row">
          <label>Medio de pago *</label>
          <select [(ngModel)]="medioPago">
            <option value="" disabled selected>Selecciona medio de pago</option>
            <option>Efectivo</option>
            <option>Transferencia</option>
            <option>Tarjeta</option>
            <option>Otro</option>
          </select>
        </div>
        <div class="form-row">
          <label>Notas (opcional)</label>
          <textarea rows="3" [(ngModel)]="notas"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-chip btn-cancel" (click)="cerrarModalFinalizar()">Cancelar</button>
      <button class="action-chip btn-finish" (click)="guardarFinalizacion()">‚úî Guardar finalizaci√≥n</button>
    </div>
  </div>
</div>

<!-- =================== MODAL: VER DETALLE (solo lectura) =================== -->
<!-- Para abrir este modal agrega la clase 'is-open' en el div.modal-backdrop -->
<div class="modal-backdrop" [class.is-open]="modalDetalleAbierto">
  <div class="modal-card">
    <div class="modal-header">
      <h3>üëÅÔ∏è Detalle de finalizaci√≥n</h3>
      <button class="modal-close" (click)="cerrarModalDetalle()">‚úñ</button>
    </div>
    <div class="modal-body" *ngIf="detalleSeleccionado">
      <div class="detail-grid">
        <div><span class="detail-label">N¬∞ Solicitud:</span> {{ detalleSeleccionado.idSolicitud }}</div>
        <div><span class="detail-label">Cliente:</span> {{ detalleSeleccionado.clienteNombre }}</div>
        <div><span class="detail-label">Proveedor:</span> {{ detalleSeleccionado.proveedorNombre }}</div>
        <div><span class="detail-label">Fecha finalizado:</span> {{ formatoFecha(detalleSeleccionado.fechaRealizacion) }}</div>
        <div><span class="detail-label">Precio cobrado:</span> {{ formatoPrecio(detalleSeleccionado.precioAcordado) }}</div>
        <div><span class="detail-label">Medio de pago:</span> {{ detalleSeleccionado.medioDePago || '‚Äî' }}</div>
        <div class="full"><span class="detail-label">Notas:</span> {{ detalleSeleccionado.notas || '‚Äî' }}</div>
        <div class="full"><span class="detail-label">Denuncia:</span> <span>No</span></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-chip btn-cancel" (click)="cerrarModalDetalle()">Cerrar</button>
    </div>
  </div>
</div>

