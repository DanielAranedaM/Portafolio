<div class="requests-container" role="region" aria-label="Solicitudes agendadas">
  <header class="requests-header" role="banner">
    <div class="header-main">
      <button class="btn-back-icon" aria-label="Volver" (click)="routeMenu()">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div>
        <h1 class="header-title">Mis Solicitudes</h1>
        <p class="header-subtitle">Gestiona tus servicios agendados</p>
      </div>
    </div>

    <div class="header-actions">
      <button class="btn-refresh-icon" (click)="refresh()" [disabled]="isRefreshing" title="Actualizar">
        <i class="bi bi-arrow-clockwise" [class.spin]="isRefreshing"></i>
      </button>
    </div>
  </header>

  <section class="stats-row">
    <div class="stat-item">
      <span class="stat-value">{{ summary.total }}</span>
      <span class="stat-label">Total</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item text-agendado">
      <span class="stat-value">{{ summary.agendados }}</span>
      <span class="stat-label">Agendados</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item text-completado">
      <span class="stat-value">{{ summary.completados }}</span>
      <span class="stat-label">Completados</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item text-finalizado">
      <span class="stat-value">{{ summary.finalizados }}</span>
      <span class="stat-label">Finalizados</span>
    </div>
  </section>

  <nav class="filters-nav">
    <button class="filter-chip" [class.active]="filtroEstado === 'Todos'" (click)="setFiltro('Todos')">Todos</button>
    <button class="filter-chip" [class.active]="filtroEstado === 'Agendado'" (click)="setFiltro('Agendado')">Agendados</button>
    <button class="filter-chip" [class.active]="filtroEstado === 'Completado'" (click)="setFiltro('Completado')">Completados</button>
    <button class="filter-chip" [class.active]="filtroEstado === 'Finalizado'" (click)="setFiltro('Finalizado')">Finalizados</button>
  </nav>

  <section class="cards-grid" *ngIf="dataLoaded">
    
    <div class="empty-state" *ngIf="solicitudesFiltradas.length === 0">
      <div class="empty-icon">üì≠</div>
      <h3>No hay solicitudes en este estado</h3>
      <p>Cambia el filtro o actualiza la lista.</p>
    </div>

    <article class="request-card" *ngFor="let s of solicitudesFiltradas">
      <div class="card-header">
        <div class="card-id">#{{ s.idSolicitud }}</div>
        <span class="status-badge" [ngClass]="{
          'status-agendado': s.estado === 'Agendado',
          'status-completado': s.estado === 'Completado',
          'status-finalizado': s.estado === 'Finalizado',
          'status-cancelado': s.estado === 'Cancelado'
        }">{{ s.estado }}</span>
      </div>

      <div class="card-body">
        <div class="info-row">
          <div class="info-col">
            <span class="label">Fecha Agendada</span>
            <span class="value date-highlight">{{ formatoFecha(s.fechaAgendamiento) }}</span>
          </div>
          <div class="info-col text-end">
            <span class="label">Precio</span>
            <span class="value price">{{ formatoPrecio(s.precioAcordado) }}</span>
          </div>
        </div>

        <div class="people-row">
          <div class="person">
            <span class="role-label">Cliente</span>
            <span class="person-name">{{ s.clienteNombre }}</span>
          </div>
          <div class="arrow">‚ûù</div>
          <div class="person">
            <span class="role-label">Proveedor</span>
            <span class="person-name">{{ s.proveedorNombre }}</span>
          </div>
        </div>

        <div class="timeline-mini">
          <div class="step step-done"></div> 
          
          <div class="line" [class.line-done]="s.estado !== 'Agendado' && s.estado !== 'Cancelado'"></div>
          
          <div class="step" [class.step-done]="s.estado !== 'Agendado' && s.estado !== 'Cancelado'"></div> 
          
          <div class="line" [class.line-done]="s.estado === 'Finalizado'"></div>
          
          <div class="step" [class.step-done]="s.estado === 'Finalizado'"></div> 
        </div>
        
        <div class="timeline-labels">
          <span>Inicio</span>
          <span>Completado</span>
          <span>Fin</span>
        </div>

        <div class="dates-secondary" *ngIf="s.estado !== 'Agendado'">
          <div *ngIf="s.estado === 'Completado' || s.estado === 'Finalizado'">
            <i class="bi bi-check-circle"></i> Completado: {{ formatoFecha(s.fechaCreacion) }}
          </div>
          <div *ngIf="s.fechaRealizacion">
            <i class="bi bi-check-all"></i> Finalizado: {{ formatoFecha(s.fechaRealizacion) }}
          </div>
           <div *ngIf="s.estado === 'Cancelado'" style="color: #dc3545;">
            <i class="bi bi-x-circle"></i> Servicio Cancelado
          </div>
        </div>
      </div>

      <div class="card-footer" *ngIf="mostrarColumnaAcciones">
        
        <button 
          class="btn-action btn-cancel" 
          *ngIf="s.estado !== 'Completado' && s.estado !== 'Finalizado' && s.estado !== 'Cancelado'"
          (click)="abrirModalCancelar(s)" 
          title="Cancelar servicio">
          ‚úñ Cancelar
        </button>

        <button *ngIf="isCliente && s.estado === 'Agendado'" 
                class="btn-action btn-complete" 
                (click)="onClickCompletar(s)">
          <i class="bi bi-check-lg"></i> Marcar Completado
        </button>

        <button *ngIf="isProveedor && s.estado === 'Completado'" 
                class="btn-action btn-finish" 
                (click)="onClickFinalizar(s)">
          <i class="bi bi-check2-all"></i> Finalizar Servicio
        </button>

        <button *ngIf="isProveedor && s.estado === 'Finalizado'" 
                class="btn-action btn-detail" 
                (click)="abrirModalDetalle(s)">
          <i class="bi bi-eye"></i> Ver Detalle
        </button>
      </div>
    </article>
    
  </section>
  
</div>

<div class="modal-backdrop" 
     [class.is-open]="modalEvaluacionAbierto"
     [attr.aria-hidden]="!modalEvaluacionAbierto">
  <div class="modal-card modal-card-evaluacion" role="dialog">
    <div class="modal-header modal-header--center">
      <h3 id="titulo-evaluacion">¬øDesea evaluar el servicio?</h3>
    </div>
    <div class="modal-body modal-body--center">
      <p class="eval-text">
        Su opini√≥n nos ayuda a mejorar.  
        ¬øQuiere evaluar ahora o prefiere hacerlo m√°s tarde?
      </p>
    </div>
    <div class="modal-footer modal-footer--stacked">
      <button class="eval-btn eval-btn-primary" (click)="irAEvaluacion()">
        ‚úÖ Ir a evaluar ahora
      </button>
      <button class="eval-btn eval-btn-secondary" (click)="posponerEvaluacion()">
        ‚è±Ô∏è M√°s tarde
      </button>
    </div>
  </div>
</div>

<div class="modal-backdrop" 
     [class.is-open]="modalAbierto" 
     [attr.aria-hidden]="!modalAbierto">
  <div class="modal-card" role="dialog">
    <div class="modal-header">
      <h3>‚úî Finalizar servicio</h3>
      <button class="modal-close" (click)="cerrarModalFinalizar()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-row">
          <label>Precio cobrado *</label>
          <input type="number" [(ngModel)]="precioCobrado" placeholder="$ 0" class="form-input" />
        </div>
        <div class="form-row">
          <label>Medio de pago *</label>
          <select [(ngModel)]="medioPago" class="form-select">
            <option value="" disabled selected>Selecciona medio de pago</option>
            <option>Efectivo</option>
            <option>Transferencia</option>
            <option>Tarjeta</option>
            <option>Otro</option>
          </select>
        </div>
        <div class="form-row">
          <label>Notas (opcional)</label>
          <textarea rows="3" [(ngModel)]="notas" class="form-textarea"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-text" (click)="cerrarModalFinalizar()">Cancelar</button>
      <button class="btn-primary" (click)="guardarFinalizacion()">Guardar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" 
     [class.is-open]="modalDetalleAbierto"
     [attr.aria-hidden]="!modalDetalleAbierto">
  <div class="modal-card">
    <div class="modal-header">
      <h3>üëÅÔ∏è Detalle de finalizaci√≥n</h3>
      <button class="modal-close" (click)="cerrarModalDetalle()">‚úñ</button>
    </div>
    <div class="modal-body" *ngIf="detalleSeleccionado">
      <div class="detail-grid">
        <div><span class="detail-label">N¬∞ Solicitud:</span> {{ detalleSeleccionado.idSolicitud }}</div>
        <div><span class="detail-label">Cliente:</span> {{ detalleSeleccionado.clienteNombre }}</div>
        <div><span class="detail-label">Proveedor:</span> {{ detalleSeleccionado.proveedorNombre }}</div>
        <div><span class="detail-label">Fecha finalizado:</span> {{ formatoFecha(detalleSeleccionado.fechaRealizacion) }}</div>
        <div><span class="detail-label">Precio cobrado:</span> {{ formatoPrecio(detalleSeleccionado.precioAcordado) }}</div>
        <div><span class="detail-label">Medio de pago:</span> {{ detalleSeleccionado.medioDePago || '‚Äî' }}</div>
        <div class="full"><span class="detail-label">Notas:</span> {{ detalleSeleccionado.notas || '‚Äî' }}</div>
        <div class="full"><span class="detail-label">Denuncia:</span> <span>No</span></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-chip btn-cancel" (click)="cerrarModalDetalle()">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" 
     [class.is-open]="modalCancelarAbierto"
     [attr.aria-hidden]="!modalCancelarAbierto">
  
  <div class="modal-card modal-danger"> <div class="modal-header">
      <h3>‚ö†Ô∏è Cancelar Solicitud</h3>
      <button class="modal-close" (click)="cerrarModalCancelar()">‚úñ</button>
    </div>

    <div class="modal-body" *ngIf="solicitudACancelar">
      <p>
        Est√°s a punto de cancelar la solicitud 
        <strong>#{{ solicitudACancelar.idSolicitud }}</strong> con 
        <strong>{{ isProveedor ? solicitudACancelar.clienteNombre : solicitudACancelar.proveedorNombre }}</strong>.
      </p>
      <p class="warning-text">
        Esta acci√≥n es irreversible y el servicio quedar√° anulado.
      </p>

      <div *ngIf="mensajeErrorCancelar" class="error-banner">
        {{ mensajeErrorCancelar }}
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="cerrarModalCancelar()">Volver</button>
      <button class="btn-danger-action" (click)="confirmarCancelacion()">
        S√≠, Cancelar Servicio
      </button>
    </div>
  </div>
</div>