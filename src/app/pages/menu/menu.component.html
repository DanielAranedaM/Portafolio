<!-- Botón para mostrar/ocultar sidebar -->
<button 
  [class]="toggleButtonClasses"
  [title]="toggleTitle"
  (click)="toggleSidebar()">
  {{ toggleIcon }}
</button>

<!-- Barra lateral de perfil -->
<aside [class]="sidebarClasses">
  <br>
  <br>
    <div class="welcome-section">
        <!-- Titulo -->
        <h2 class="welcome-title">Bienvenido Usuario</h2>
        
        <!-- Foto Perfil CON FUNCIONALIDAD -->
        <div class="profile-photo" (click)="openPhotoModal()">
          <!-- Imagen si existe -->
          <img 
            *ngIf="hasProfileImage" 
            [src]="profileImageUrl" 
            alt="Foto de perfil">
          <!-- Iniciales si no hay imagen -->
          <span *ngIf="!hasProfileImage" id="profileInitials">{{ userInitials }}</span>
          <!-- Overlay de cámara -->
          <div class="camera-overlay">📷</div>
        </div>
        
        <!-- Nombre de Usuario -->
        <div class="user-name">{{ userName }}</div>

        <!-- Clasificación dinámica -->
        <div class="rating-section">
            <div class="stars">
                <!-- Mostrar estrellas dinámicamente -->
                <ng-container *ngIf="userRating !== null && userRating > 0; else noRating">
                <ng-container *ngFor="let star of [1,2,3,4,5]">
                    <span *ngIf="userRating >= star">★</span>
                    <span *ngIf="userRating < star && userRating >= star - 0.5">⯨</span>
                    <span *ngIf="userRating < star - 0.5">☆</span>
                </ng-container>
                </ng-container>

                <!-- Si no hay evaluación -->
                <ng-template #noRating>
                <span>☆☆☆☆☆</span>
                </ng-template>
            </div>

            <span class="rating-text">
                {{ userRating !== null ? (userRating | number:'1.1-1') : '0.0' }}
            </span>
        </div>

    </div>

    <!-- Descripción -->
    <div class="description-section">
        <h3 class="section-title">Descripción</h3>
        <p class="description-text">
            {{ userDescription || '—' }}
        </p>
    </div>

    <!-- Recomendaciones -->
    <div class="reviews-section">
        <h3 class="section-title">Recomendaciones</h3>
        <div class="review-item">
            <div class="review-author">Elena Nito</div>
            <p class="review-text">"Excelente trabajo en mi jardín. Muy profesional y puntual."</p>
        </div>
        <div class="review-item">
            <div class="review-author">Armando Casas</div>
            <p class="review-text">"Recomiendo 100%. Transformó completamente mi patio."</p>
        </div>
    </div>

    <!-- Btns de Acción -->
    <div class="action-buttons">
        <button class="action-btn btn-primary" (click)="routePerfil()">✏️ Editar Perfil</button>
        <button *ngIf="isProveedor" class="action-btn btn-success" (click)="routeRegistrarServicio()">➕ Publicar Servicio</button>
        <button class="action-btn btn-secondary">📷 Subir Fotos</button>
        <button class="action-btn btn-danger" (click)="openLogoutModal()">🚪 Cerrar Sesión</button>
    </div>
</aside>

<!-- MODAL PARA SELECCIONAR FOTO -->
<div *ngIf="photoModalVisible" class="modal" (click)="onModalBackdropClick($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <span class="close" (click)="closePhotoModal()">&times;</span>
    <h3>Cambiar foto de perfil</h3>
    <button (click)="takePhoto()">📷 Tomar foto</button>
    <button (click)="uploadPhoto()">📁 Subir archivo</button>
    <button *ngIf="hasProfileImage" (click)="removePhoto()" style="background: #f44336;">🗑️ Eliminar foto</button>
  </div>
</div>

<!-- MODAL DE CÁMARA -->
<div *ngIf="cameraModalVisible" class="camera-modal" (click)="onCameraBackdropClick($event)">
  <div class="camera-container" (click)="$event.stopPropagation()">
    <div class="camera-header">
      <h3>Tomar foto</h3>
      <button class="close-camera" (click)="closeCameraModal()">&times;</button>
    </div>
    
    <div class="camera-content">
      <video id="cameraVideo" autoplay playsinline muted></video>
      <canvas id="photoCanvas" style="display: none;"></canvas>
    </div>
    
    <div class="camera-controls">
      <button class="camera-btn switch-btn" (click)="switchCamera()" title="Cambiar cámara">
        Cambiar Cámara
      </button>
      <button class="camera-btn capture-btn" (click)="capturePhoto()" title="Capturar foto">
        TOMAR FOTO
      </button>
      <button class="camera-btn cancel-btn" (click)="closeCameraModal()" title="Cancelar">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- INPUTS OCULTOS PARA MANEJO DE ARCHIVOS -->
<input 
  type="file" 
  id="cameraInput" 
  accept="image/*" 
  capture="camera" 
  style="display: none;" 
  (change)="handlePhotoUpload($event)">

<input 
  type="file" 
  id="fileInput" 
  accept="image/*" 
  style="display: none;" 
  (change)="handlePhotoUpload($event)">

<!-- Contenido principal -->
<main [class]="mainContentClasses">
    <div class="platform-container">
        <header class="platform-header">
            <div class="logo">
                <div class="logo-icon">🔍</div>
                <h1 class="logo-text">EL DATO</h1>
            </div>
        </header>

        <!-- Barra de busqueda -->
        <section class="search-section">
            <div class="search-bar">
                <input type="text" placeholder="¿Qué Dato necesitas hoy?" id="searchInput">
                <button class="search-btn" (click)="buscarServicio()">Buscar</button>
            </div>
        </section>

        <section class="services-grid">
            <!-- Loading / error -->
            <div *ngIf="categoriasLoading" class="service-card" style="opacity:.7; pointer-events:none;">
                <div class="service-icon">⏳</div>
                <h3 class="service-title">Cargando categorías...</h3>
                <p class="service-description">Espera un momento</p>
            </div>

            <div *ngIf="!categoriasLoading && categoriasError" class="service-card" style="border-color:#f44336;">
                <div class="service-icon">⚠️</div>
                <h3 class="service-title">Error</h3>
                <p class="service-description">{{ categoriasError }}</p>
            </div>

            <!-- Listado dinámico -->
            <div
                class="service-card"
                *ngFor="let cat of categorias"
                (click)="seleccionarCategoria(cat)"
                title="Ver servicios cercanos en {{cat.nombre}}">
                <div class="service-icon">🧩</div>
                <h3 class="service-title">{{ cat.nombre }}</h3>
                <p class="service-description">{{ cat.descripcion || '—' }}</p>
            </div>
        </section>
        
        <section *ngIf="serviciosLoading" class="recent-searches">
            <h3 class="recent-title">Buscando servicios cercanos...</h3>
        </section>

        <section *ngIf="!serviciosLoading && !serviciosError && serviciosDeCategoria && serviciosDeCategoria.length === 0" class="recent-searches">
            <h3 class="recent-title">Sin resultados</h3>
            <div class="search-item">
                <div class="search-item-icon">😔</div>
                <span class="search-item-text">
                No encontramos servicios en esta categoría cerca de ti por ahora.
                Intenta con otra categoría o vuelve a intentarlo más tarde.
                </span>
            </div>
        </section>

        <section *ngIf="!serviciosLoading && serviciosDeCategoria?.length" class="recent-searches">
            <h3 class="recent-title">Servicios cercanos</h3>
            <div class="search-item" *ngFor="let s of serviciosDeCategoria">
                <div class="search-item-icon">🔎</div>
                <span class="search-item-text">
                {{ s.titulo }} — {{ s.categoriaNombre || ('Cat #' + s.idCategoriaServicio) }}
                <ng-container *ngIf="s.proveedorNombre"> · por {{ s.proveedorNombre }}</ng-container>
                <ng-container *ngIf="s.precioBase"> · $ {{ s.precioBase | number:'1.0-0' }}</ng-container>
                </span>
            </div>
        </section>

        <section class="recent-searches">
            <h3 class="recent-title">Búsquedas Recientes</h3>
            <div class="search-item" (click)="buscarReciente('jardineria')">
                <div class="search-item-icon">🌱</div>
                <span class="search-item-text">Jardinería en mi zona</span>
            </div>
            <div class="search-item" (click)="buscarReciente('limpieza')">
                <div class="search-item-icon">🧹</div>
                <span class="search-item-text">Limpieza semanal</span>
            </div>
            <div class="search-item" (click)="buscarReciente('plomeria')">
                <div class="search-item-icon">🔧</div>
                <span class="search-item-text">Plomero urgente</span>
            </div>
        </section>
    </div>
</main>

<!-- MODAL DE CONFIRMACIÓN PARA CERRAR SESIÓN -->
<div *ngIf="logoutModalVisible" class="logout-modal-overlay" (click)="closeLogoutModal()">
    <div class="logout-modal-content" (click)="$event.stopPropagation()">
        <div class="logout-modal-header">
            <div class="logout-modal-icon">
                <span class="logout-icon">🚪</span>
            </div>
            <button class="close-logout-btn" (click)="closeLogoutModal()">×</button>
        </div>
        
        <div class="logout-modal-body">
            <h3>¿Cerrar Sesión?</h3>
            <p>¿Estás seguro de que deseas cerrar tu sesión?</p>
            <p class="logout-warning">Tendrás que iniciar sesión nuevamente para acceder a tu cuenta.</p>
        </div>
        
        <div class="logout-modal-footer">
            <button class="logout-btn-cancel" (click)="closeLogoutModal()">
                Cancelar
            </button>
            <button class="logout-btn-confirm" (click)="confirmLogout()">
                Sí, Cerrar Sesión
            </button>
        </div>
    </div>
</div>
