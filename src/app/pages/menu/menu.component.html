<!-- BotÃ³n para mostrar/ocultar sidebar -->
<button 
  [class]="toggleButtonClasses"
  [title]="toggleTitle"
  (click)="toggleSidebar()">
  {{ toggleIcon }}
</button>

<!-- Barra lateral de navegaciÃ³n -->
<aside [class]="sidebarClasses">
  
  <!-- SecciÃ³n de foto de perfil -->
  <div class="profile-photo-section">
    <!-- TÃ­tulo de bienvenida -->
    <h2 class="welcome-title">Bienvenido</h2>
    
    <!-- Foto Perfil CON FUNCIONALIDAD -->
    <div class="profile-photo-large" (click)="openPhotoModal()">
      <!-- Imagen si existe -->
      <img 
        *ngIf="hasProfileImage" 
        [src]="profileImageUrl" 
        alt="Foto de perfil">
      <!-- Iniciales si no hay imagen -->
      <span *ngIf="!hasProfileImage" class="profile-initials-large">{{ userInitials }}</span>
      <!-- Overlay de cÃ¡mara -->
      <div class="camera-overlay">ğŸ“·</div>
    </div>
    
    <!-- InformaciÃ³n del usuario -->
    <div class="profile-info">
      <h3 class="profile-name">{{ userName }}</h3>
      
      <!-- ClasificaciÃ³n solo para proveedores -->
      <div class="rating-section" *ngIf="userRole === 'proveedor'">
        <div class="stars">
          <ng-container *ngIf="userRating !== null && userRating > 0; else noRating">
            <ng-container *ngFor="let star of [1,2,3,4,5]">
              <span *ngIf="userRating >= star">â˜…</span>
              <span *ngIf="userRating < star && userRating >= star - 0.5">â¯¨</span>
              <span *ngIf="userRating < star - 0.5">â˜†</span>
            </ng-container>
          </ng-container>
          <ng-template #noRating>
            <span>â˜†â˜†â˜†â˜†â˜†</span>
          </ng-template>
        </div>
        <span class="rating-text">
          {{ userRating !== null ? (userRating | number:'1.1-1') : '0.0' }}
        </span>
      </div>
    </div>
  </div>

  <!-- MenÃº de navegaciÃ³n segÃºn el rol -->
  <nav class="profile-navigation">
    
    <!-- Opciones para Proveedor -->
    <ng-container *ngIf="userRole === 'proveedor'">
      <button class="nav-btn" (click)="routePerfil()">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-text">Mi Perfil</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToMyServices()">
        <span class="nav-icon">ğŸ”§</span>
        <span class="nav-text">Mis Servicios</span>
      </button>
      
      <button class="nav-btn" (click)="routeRegistrarServicio()">
        <span class="nav-icon">â•</span>
        <span class="nav-text">Publicar Servicio</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToMyReviews()">
        <span class="nav-icon">â­</span>
        <span class="nav-text">Mis ReseÃ±as</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToSettings()">
        <span class="nav-icon">âš™ï¸</span>
        <span class="nav-text">ConfiguraciÃ³n</span>
      </button>
    </ng-container>

    <!-- Opciones para Cliente -->
    <ng-container *ngIf="userRole === 'cliente'">
      <button class="nav-btn" (click)="routePerfil()">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-text">Mi Perfil</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToSavedServices()">
        <span class="nav-icon">ğŸ’¾</span>
        <span class="nav-text">Servicios Guardados</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToNotifications()">
        <span class="nav-icon">ğŸ””</span>
        <span class="nav-text">Notificaciones</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToSettings()">
        <span class="nav-icon">âš™ï¸</span>
        <span class="nav-text">ConfiguraciÃ³n</span>
      </button>
    </ng-container>

    <!-- Cerrar sesiÃ³n (comÃºn para ambos) -->
    <button class="nav-btn logout-btn" (click)="openLogoutModal()">
      <span class="nav-icon">ğŸšª</span>
      <span class="nav-text">Cerrar SesiÃ³n</span>
    </button>
    
  </nav>
  
</aside>

<!-- MODAL PARA SELECCIONAR FOTO -->
<div *ngIf="photoModalVisible" class="modal" (click)="onModalBackdropClick($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <span class="close" (click)="closePhotoModal()">&times;</span>
    <h3>Cambiar foto de perfil</h3>
    <button (click)="takePhoto()">ğŸ“· Tomar foto</button>
    <button (click)="uploadPhoto()">ğŸ“ Subir archivo</button>
    <button *ngIf="hasProfileImage" (click)="removePhoto()" style="background: #f44336;">ğŸ—‘ï¸ Eliminar foto</button>
  </div>
</div>

<!-- MODAL DE CÃMARA -->
<div *ngIf="cameraModalVisible" class="camera-modal" (click)="onCameraBackdropClick($event)">
  <div class="camera-container" (click)="$event.stopPropagation()">
    <div class="camera-header">
      <h3>Tomar foto</h3>
      <button class="close-camera" (click)="closeCameraModal()">&times;</button>
    </div>
    
    <div class="camera-content">
      <video id="cameraVideo" autoplay playsinline muted></video>
      <canvas id="photoCanvas" style="display: none;"></canvas>
    </div>
    
    <div class="camera-controls">
      <button class="camera-btn switch-btn" (click)="switchCamera()" title="Cambiar cÃ¡mara">
        Cambiar CÃ¡mara
      </button>
      <button class="camera-btn capture-btn" (click)="capturePhoto()" title="Capturar foto">
        TOMAR FOTO
      </button>
      <button class="camera-btn cancel-btn" (click)="closeCameraModal()" title="Cancelar">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- INPUTS OCULTOS PARA MANEJO DE ARCHIVOS -->
<input 
  type="file" 
  id="cameraInput" 
  accept="image/*" 
  capture="camera" 
  style="display: none;" 
  (change)="handlePhotoUpload($event)">

<input 
  type="file" 
  id="fileInput" 
  accept="image/*" 
  style="display: none;" 
  (change)="handlePhotoUpload($event)">

<!-- Contenido principal -->
<main [class]="mainContentClasses">
    
  <!-- ========== DASHBOARD PARA CLIENTES ========== -->
  <div *ngIf="isCliente" class="platform-container">
    <header class="platform-header">
      <div class="logo">
        <div class="logo-icon">ğŸ”</div>
        <h1 class="logo-text">EL DATO</h1>
      </div>
    </header>

    <!-- Barra de bÃºsqueda -->
    <section class="search-section">
      <div class="search-bar">
        <input
          type="text"
          placeholder="Â¿QuÃ© Dato necesitas hoy?"
          id="searchInput"
          (keyup.enter)="buscarServicio()"
        >
        <button class="search-btn" (click)="buscarServicio()">Buscar</button>
      </div>
    </section>


    <!-- CATEGORÃAS (COLAPSABLES) -->
    <section class="services-grid">
      <div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
        <h3 class="section-title" style="margin:0; display:flex; align-items:center; gap:8px;">
          <span>ğŸ§©</span> <span>CategorÃ­as</span>
        </h3>
        <button class="nav-btn" (click)="toggleCategorias()" title="Mostrar/Ocultar categorÃ­as" style="display:flex; align-items:center; gap:6px;">
          <span>{{ categoriasArrowIcon }}</span>
          <span>{{ categoriasCollapsed ? 'Mostrar' : 'Ocultar' }}</span>
        </button>
      </div>

      <!-- Loading / error de categorÃ­as -->
      <div *ngIf="categoriasLoading" class="service-card" style="opacity:.7; pointer-events:none;">
        <div class="service-icon">â³</div>
        <h3 class="service-title">Cargando categorÃ­as...</h3>
        <p class="service-description">Espera un momento</p>
      </div>

      <div *ngIf="!categoriasLoading && categoriasError" class="service-card" style="border-color:#f44336;">
        <div class="service-icon">âš ï¸</div>
        <h3 class="service-title">Error</h3>
        <p class="service-description">{{ categoriasError }}</p>
      </div>

      <!-- Listado dinÃ¡mico (solo si NO estÃ¡ colapsado) -->
      <ng-container *ngIf="!categoriasCollapsed">
        <div
          class="service-card"
          *ngFor="let cat of categorias"
          (click)="seleccionarCategoria(cat)"
          title="Ver servicios cercanos en {{cat.nombre}}">
          <div class="service-icon">ğŸ§©</div>
          <h3 class="service-title">{{ cat.nombre }}</h3>
          <p class="service-description">{{ cat.descripcion || 'â€”' }}</p>
        </div>
      </ng-container>
    </section>

    <!-- RESULTADOS UNIFICADOS (tanto bÃºsqueda como categorÃ­a) -->
    <section *ngIf="loading" class="recent-searches">
      <h3 class="recent-title">
        {{ resultMode === 'category' ? 'Buscando servicios cercanos...' : 'Buscandoâ€¦' }}
      </h3>
    </section>

    <section *ngIf="!loading && error" class="recent-searches">
      <h3 class="recent-title">Resultado</h3>
      <div class="search-item">
        <div class="search-item-icon">âš ï¸</div>
        <span class="search-item-text">{{ error }}</span>
      </div>
    </section>

    <section *ngIf="!loading && !error && results.length" class="recent-searches">
      <h3 class="recent-title">
        {{ resultMode === 'category' ? 'Servicios cercanos' : 'Resultados' }}
      </h3>
      <div class="search-item" *ngFor="let s of results">
        <div class="search-item-icon">ğŸ”</div>
        <span class="search-item-text">
          {{ s.titulo }} â€” {{ s.categoriaNombre || ('Cat #' + s.idCategoriaServicio) }}
          <ng-container *ngIf="s.proveedorNombre"> Â· por {{ s.proveedorNombre }}</ng-container>
          <ng-container *ngIf="s.precioBase"> Â· $ {{ s.precioBase | number:'1.0-0' }}</ng-container>
        </span>
      </div>
    </section>

    <!-- BÃºsquedas recientes -->
    <section class="recent-searches">
      <h3 class="recent-title">BÃºsquedas Recientes</h3>
      <div class="search-item" (click)="buscarReciente('jardineria')">
        <div class="search-item-icon">ğŸŒ±</div>
        <span class="search-item-text">JardinerÃ­a en mi zona</span>
      </div>
      <div class="search-item" (click)="buscarReciente('limpieza')">
        <div class="search-item-icon">ğŸ§¹</div>
        <span class="search-item-text">Limpieza semanal</span>
      </div>
      <div class="search-item" (click)="buscarReciente('plomeria')">
        <div class="search-item-icon">ğŸ”§</div>
        <span class="search-item-text">Plomero urgente</span>
      </div>
    </section>
  </div>

  <!-- ========== DASHBOARD PARA PROVEEDORES ========== -->
  <div *ngIf="isProveedor" class="proveedor-dashboard">
    <!-- Header del Dashboard -->
    <header class="proveedor-header">
      <div class="proveedor-title-section">
        <div class="proveedor-icon">ğŸ‘·</div>
        <div>
          <h1 class="proveedor-title">Mi Negocio</h1>
          <p class="proveedor-subtitle">Panel del Proveedor</p>
        </div>
      </div>
    </header>

    <!-- Tarjetas de EstadÃ­sticas -->
    <section class="stats-section">
      <div class="stat-card">
        <div class="stat-icon services-icon">ğŸ”§</div>
        <div class="stat-content">
          <div class="stat-number">{{ proveedorStats.serviciosActivos }}</div>
          <div class="stat-label">Servicios Activos</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon contacts-icon">ğŸ“</div>
        <div class="stat-content">
          <div class="stat-number">{{ proveedorStats.contactosEsteMes }}</div>
          <div class="stat-label">Contactos Este Mes</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon rating-icon">â­</div>
        <div class="stat-content">
          <div class="stat-number">{{ userRating || '0.0' }}</div>
          <div class="stat-label">Rating ({{ proveedorStats.totalResenas }})</div>
        </div>
      </div>
    </section>

    <!-- BotÃ³n Principal de AcciÃ³n -->
    <section class="main-action-section">
      <button class="btn-main-action" (click)="routeRegistrarServicio()">
        <span class="btn-icon">â•</span>
        <span class="btn-text">Publicar Nuevo Servicio</span>
      </button>
    </section>

    <!-- Mis Servicios Publicados -->
    <section class="services-list-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="title-icon">ğŸ“‹</span>
          Mis Servicios Publicados
        </h2>
      </div>

      <div class="services-list" *ngIf="misServicios.length > 0; else noServices">
        <div class="service-item" *ngFor="let servicio of misServicios">
          <div class="service-item-header">
            <div class="service-item-title-section">
              <h3 class="service-item-title">{{ servicio.titulo }}</h3>
              <span class="service-item-category">{{ servicio.categoria }}</span>
            </div>
          </div>
          
          <div class="service-item-stats">
            <div class="service-stat">
              <span class="service-stat-icon">ğŸ‘ï¸</span>
              <span class="service-stat-value">{{ servicio.vistas }} vistas</span>
            </div>
            <div class="service-stat">
              <span class="service-stat-icon">ğŸ“</span>
              <span class="service-stat-value">{{ servicio.contactos }} contactos</span>
            </div>
          </div>

          <div class="service-item-actions">
            <button class="service-btn btn-view" (click)="verDetalleServicio(servicio)">
              ğŸ‘ï¸ Ver
            </button>
            <button class="service-btn btn-edit" (click)="editarServicio(servicio)">
              âœï¸ Editar
            </button>
          </div>
        </div>
      </div>

      <ng-template #noServices>
        <div class="empty-state">
          <div class="empty-icon">ğŸ“</div>
          <h3 class="empty-title">No tienes servicios publicados</h3>
          <p class="empty-text">Publica tu primer servicio para que los clientes puedan encontrarte</p>
          <button class="btn-empty-action" (click)="routeRegistrarServicio()">
            â• Publicar Mi Primer Servicio
          </button>
        </div>
      </ng-template>
    </section>

    <!-- ReseÃ±as Recientes -->
    <section class="reviews-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="title-icon">â­</span>
          ReseÃ±as Recientes
        </h2>
        <button class="btn-view-all" (click)="verTodasResenas()">Ver todas â†’</button>
      </div>

      <div class="reviews-list" *ngIf="ultimasResenas.length > 0; else noReviews">
        <div class="review-item" *ngFor="let resena of ultimasResenas">
          <div class="review-header">
            <div class="review-stars">{{ renderStars(resena.rating) }}</div>
            <div class="review-date">{{ resena.fecha | date:'dd/MM/yyyy' }}</div>
          </div>
          <p class="review-comment">"{{ resena.comentario }}"</p>
          <p class="review-author">- {{ resena.nombreCliente }}</p>
        </div>
      </div>

      <ng-template #noReviews>
        <div class="empty-state-small">
          <div class="empty-icon-small">ğŸŒŸ</div>
          <p class="empty-text-small">AÃºn no tienes reseÃ±as. Cuando completes servicios, los clientes podrÃ¡n dejarte sus comentarios.</p>
        </div>
      </ng-template>
    </section>
  </div>

</main>

<!-- MODAL DE CONFIRMACIÃ“N PARA CERRAR SESIÃ“N -->
<div *ngIf="logoutModalVisible" class="logout-modal-overlay" (click)="closeLogoutModal()">
  <div class="logout-modal-content" (click)="$event.stopPropagation()">
    <div class="logout-modal-header">
      <div class="logout-modal-icon">
        <span class="logout-icon">ğŸšª</span>
      </div>
      <button class="close-logout-btn" (click)="closeLogoutModal()">Ã—</button>
    </div>
    
    <div class="logout-modal-body">
      <h3>Â¿Cerrar SesiÃ³n?</h3>
      <p>Â¿EstÃ¡s seguro de que deseas cerrar tu sesiÃ³n?</p>
      <p class="logout-warning">TendrÃ¡s que iniciar sesiÃ³n nuevamente para acceder a tu cuenta.</p>
    </div>
    
    <div class="logout-modal-footer">
      <button class="logout-btn-cancel" (click)="closeLogoutModal()">
        Cancelar
      </button>
      <button class="logout-btn-confirm" (click)="confirmLogout()">
        SÃ­, Cerrar SesiÃ³n
      </button>
    </div>
  </div>
</div>
