<!-- Bot√≥n para mostrar/ocultar sidebar -->
<button 
  [class]="toggleButtonClasses"
  [title]="toggleTitle"
  (click)="toggleSidebar()">
  <i class="fas" [ngClass]="sidebarVisible ? 'fa-bars' : 'fa-user'"></i>
</button>

<!-- Barra lateral de navegaci√≥n -->
<aside [class]="sidebarClasses">
  
  <!-- Secci√≥n de foto de perfil -->
  <div class="profile-photo-section">
    <!-- T√≠tulo de bienvenida -->
    <h2 class="welcome-title">Bienvenido</h2>
    
    <!-- Foto Perfil CON FUNCIONALIDAD -->
    <div class="profile-photo-large" (click)="openPhotoModal()">
      <!-- Imagen si existe -->
      <img 
        *ngIf="hasProfileImage" 
        [src]="profileImageUrl" 
        alt="Foto de perfil">
      <!-- Iniciales si no hay imagen -->
      <span *ngIf="!hasProfileImage" class="profile-initials-large">{{ userInitials }}</span>
      <!-- Overlay de c√°mara -->
      <div class="camera-overlay">
        <i class="fas fa-camera"></i>
      </div>
    </div>
    
    <!-- Informaci√≥n del usuario -->
    <div class="profile-info">
      <h3 class="profile-name">{{ userName }}</h3>
      
      <!-- Clasificaci√≥n solo para proveedores -->
      <div class="rating-section" *ngIf="userRole === 'proveedor'">
        <div class="stars" [attr.aria-label]="'Calificaci√≥n ' + (userRating ?? 0 | number:'1.1-1') + ' de 5'">
          <ng-container *ngIf="userRating !== null && userRating > 0; else noRating">
            <ng-container *ngFor="let s of getStarStates(userRating)">
              <span>{{ starIcon(s) }}</span>
            </ng-container>
          </ng-container>
          <ng-template #noRating>
            <span>‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
          </ng-template>
        </div>
        <span class="rating-text">
          {{ (userRating ?? 0) | number:'1.1-1' }}
        </span>
      </div>
    </div>
  </div>

  <!-- Men√∫ de navegaci√≥n seg√∫n el rol -->
  <nav class="profile-navigation">
    
    <!-- Opciones para Proveedor -->
    <ng-container *ngIf="userRole === 'proveedor'">
      <button class="nav-btn" (click)="routePerfil()">
        <i class="fas fa-user nav-icon"></i>
        <span class="nav-text">Mi Perfil</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToSavedServices()">
        <span class="nav-icon">üíæ</span>
        <span class="nav-text">Lista de solicitudes</span>
      </button>

      <button class="nav-btn" (click)="navigateToMyServices()">
        <i class="fas fa-tools nav-icon"></i>
        <span class="nav-text">Mis Servicios</span>
      </button>
      
      <button class="nav-btn" (click)="routeRegistrarServicio()">
        <i class="fas fa-plus-circle nav-icon"></i>
        <span class="nav-text">Publicar Servicio</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToMyReviews()">
        <i class="fas fa-star nav-icon"></i>
        <span class="nav-text">Mis Rese√±as</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToSettings()">
        <i class="fas fa-cog nav-icon"></i>
        <span class="nav-text">Configuraci√≥n</span>
      </button>
    </ng-container>

    <!-- Opciones para Cliente -->
    <ng-container *ngIf="userRole === 'cliente'">
      <button class="nav-btn" (click)="routePerfil()">
        <i class="fas fa-user nav-icon"></i>
        <span class="nav-text">Mi Perfil</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToSavedServices()">
        <i class="fas fa-bookmark nav-icon"></i>
        <span class="nav-text">Servicios Guardados</span>
      </button>
      
      <button class="nav-btn" (click)="navigateToNotifications()">
        <i class="fas fa-bell nav-icon"></i>
        <span class="nav-text">Notificaciones</span>
      </button>
            
      <button class="nav-btn" (click)="navigateToMyReviews()">
        <span class="nav-icon">‚≠ê</span>
        <span class="nav-text">Mis Rese√±as</span>
      </button>

      <button class="nav-btn" (click)="navigateToSettings()">
        <i class="fas fa-cog nav-icon"></i>
        <span class="nav-text">Configuraci√≥n</span>
      </button>
    </ng-container>

    <!-- Cerrar sesi√≥n (com√∫n para ambos) -->
    <button class="nav-btn logout-btn" (click)="openLogoutModal()">
      <i class="fas fa-sign-out-alt nav-icon"></i>
      <span class="nav-text">Cerrar Sesi√≥n</span>
    </button>
    
  </nav>
  
</aside>

<!-- MODAL PARA SELECCIONAR FOTO -->
<div *ngIf="photoModalVisible" class="modal" (click)="onModalBackdropClick($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <span class="close" (click)="closePhotoModal()">&times;</span>
    <h3>Cambiar foto de perfil</h3>
    <button (click)="takePhoto()">üì∑ Tomar foto</button>
    <button (click)="uploadPhoto()">üìÅ Subir archivo</button>
    <button *ngIf="hasProfileImage" (click)="removePhoto()" style="background: #f44336;">üóëÔ∏è Eliminar foto</button>
  </div>
</div>

<!-- MODAL DE C√ÅMARA -->
<div *ngIf="cameraModalVisible" class="camera-modal" (click)="onCameraBackdropClick($event)">
  <div class="camera-container" (click)="$event.stopPropagation()">
    <div class="camera-header">
      <h3>Tomar foto</h3>
      <button class="close-camera" (click)="closeCameraModal()">&times;</button>
    </div>
    
    <div class="camera-content">
      <video id="cameraVideo" autoplay playsinline muted></video>
      <canvas id="photoCanvas" style="display: none;"></canvas>
    </div>
    
    <div class="camera-controls">
      <button class="camera-btn switch-btn" (click)="switchCamera()" title="Cambiar c√°mara">
        Cambiar C√°mara
      </button>
      <button class="camera-btn capture-btn" (click)="capturePhoto()" title="Capturar foto">
        TOMAR FOTO
      </button>
      <button class="camera-btn cancel-btn" (click)="closeCameraModal()" title="Cancelar">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- INPUTS OCULTOS PARA MANEJO DE ARCHIVOS -->
<input 
  type="file" 
  id="cameraInput" 
  accept="image/*" 
  capture="camera" 
  style="display: none;" 
  (change)="handlePhotoUpload($event)">

<input 
  type="file" 
  id="fileInput" 
  accept="image/*" 
  style="display: none;" 
  (change)="handlePhotoUpload($event)">

<!-- Contenido principal -->
<main [class]="mainContentClasses">
    
    <!-- ========== DASHBOARD PARA CLIENTES ========== -->
    <div *ngIf="isCliente" class="platform-container">
        <header class="platform-header">
            <div class="logo">
                <i class="fas fa-search logo-icon"></i>
                <h1 class="logo-text">EL DATO</h1>
            </div>
        </header>

        <!-- Barra de b√∫squeda -->
        <section class="search-section">
            <div class="search-bar">
                <input type="text" placeholder="¬øQu√© Dato necesitas hoy?" id="searchInput">
                <button class="search-btn" (click)="buscarServicio()">Buscar</button>
            </div>
        </section>

        <!-- Vista de Categor√≠as (cuando no hay categor√≠a seleccionada) -->
        <section *ngIf="!categoriaSeleccionada" class="categories-section-improved">
            <h2 class="section-main-title">
                <span class="title-emoji">üèòÔ∏è</span>
                Encuentra el servicio que necesitas
            </h2>
            
            <!-- Loading / error -->
            <div *ngIf="categoriasLoading" class="loading-state">
                <div class="loading-icon">‚è≥</div>
                <p class="loading-text">Cargando categor√≠as...</p>
            </div>

            <div *ngIf="!categoriasLoading && categoriasError" class="error-state">
                <div class="error-icon">‚ö†Ô∏è</div>
                <p class="error-text">{{ categoriasError }}</p>
            </div>

            <!-- Grid de Categor√≠as Mejorado -->
            <div class="categories-grid-improved" *ngIf="!categoriasLoading && !categoriasError">
                <div
                    class="category-card-improved"
                    *ngFor="let cat of categorias; let i = index"
                    (click)="seleccionarCategoria(cat)"
                    [attr.data-category-index]="i">
                    
                    <div class="category-emoji-large">{{ getCategoryEmoji(cat.nombre) }}</div>
                    <h3 class="category-name-large">{{ cat.nombre }}</h3>
                    <p class="category-description-large">{{ cat.descripcion || 'Servicios disponibles en tu zona' }}</p>
                    <div class="category-badge-improved">
                        <span class="badge-icon">üìç</span>
                        <span class="badge-text">{{ getServiceCount(cat) }} servicios</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Vista de Servicios (cuando se selecciona una categor√≠a) -->
        <section *ngIf="categoriaSeleccionada" class="services-view-section">
            <div class="services-header">
                <button class="btn-back" (click)="volverACategorias()">
                    <span class="back-icon">‚Üê</span>
                    <span class="back-text">Volver</span>
                </button>
                <h2 class="services-view-title">
                    <span class="title-emoji">{{ getCategoryEmoji(categoriaSeleccionada.nombre) }}</span>
                    {{ categoriaSeleccionada.nombre }}
                    <span class="services-count" *ngIf="!serviciosLoading && serviciosDeCategoria">
                        ({{ serviciosDeCategoria.length }} servicios)
                    </span>
                </h2>
            </div>

            <!-- Loading servicios -->
            <div *ngIf="serviciosLoading" class="loading-state">
                <div class="loading-icon">‚è≥</div>
                <p class="loading-text">Buscando servicios cercanos...</p>
            </div>

            <!-- Sin resultados -->
            <div *ngIf="!serviciosLoading && serviciosDeCategoria?.length === 0" class="empty-services-state">
                <div class="empty-icon">üòî</div>
                <h3 class="empty-title">No hay servicios disponibles</h3>
                <p class="empty-text">
                    No encontramos servicios en esta categor√≠a cerca de ti por ahora.
                    Intenta con otra categor√≠a o vuelve m√°s tarde.
                </p>
                <button class="btn-empty-action" (click)="volverACategorias()">
                    Ver otras categor√≠as
                </button>
            </div>

            <!-- Lista de Servicios -->
            <div class="services-list-view" *ngIf="!serviciosLoading && serviciosDeCategoria?.length">
                <div class="service-card-large" *ngFor="let servicio of serviciosDeCategoria">
                    <!-- Header del Servicio -->
                    <div class="service-card-header">
                        <div class="provider-avatar">
                            <span class="avatar-initials">{{ getProviderInitials(servicio.proveedorNombre) }}</span>
                        </div>
                        <div class="provider-info">
                            <h3 class="provider-name">{{ servicio.proveedorNombre || 'Proveedor' }}</h3>
                            <div class="provider-rating">
                                <span class="rating-stars">‚≠ê</span>
                                <span class="rating-value">5.0</span>
                                <span class="rating-count">(0)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Foto de Portada del Servicio -->
                    <div class="service-card-image">
                        <img 
                            *ngIf="servicio.urlFotoPrincipal; else placeholderImage" 
                            [src]="servicio.urlFotoPrincipal" 
                            [alt]="servicio.titulo" 
                            class="service-image">
                        <ng-template #placeholderImage>
                            <div class="service-image-placeholder">
                                <i class="fas fa-image placeholder-icon"></i>
                                <p class="placeholder-text">Sin imagen</p>
                            </div>
                        </ng-template>
                        <div class="image-overlay" *ngIf="servicio.urlFotoPrincipal"></div>
                    </div>

                    <!-- T√≠tulo y Descripci√≥n -->
                    <div class="service-card-body">
                        <h4 class="service-title-large">{{ servicio.titulo }}</h4>
                        <p class="service-description-large">{{ servicio.descripcion || 'Servicio profesional disponible en tu zona' }}</p>
                    </div>

                    <!-- Informaci√≥n Clave -->
                    <div class="service-card-meta">
                        <div class="meta-item">
                            <span class="meta-icon">üìç</span>
                            <span class="meta-text">Cerca de ti</span>
                        </div>
                        <div class="meta-item meta-item-highlight" *ngIf="servicio.precioBase">
                            <span class="meta-icon">üí∞</span>
                            <span class="meta-text">Desde ${{ servicio.precioBase | number:'1.0-0' }}</span>
                        </div>
                    </div>

                    <!-- Tel√©fono/WhatsApp -->
                    <div class="service-card-contact">
                        <div class="contact-phone">
                            <span class="phone-icon">üìû</span>
                            <span class="phone-number">+56 9 1234 5678</span>
                        </div>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="service-card-actions">
                        <button class="btn-service-action btn-contact" (click)="contactarProveedor(servicio)">
                            <span class="btn-icon">üí¨</span>
                            <span class="btn-text">Contactar</span>
                        </button>
                        <button class="btn-service-action btn-save" (click)="guardarServicio(servicio)">
                            <span class="btn-icon">üíæ</span>
                            <span class="btn-text">Guardar</span>
                        </button>
                        <button class="btn-service-action btn-view" (click)="verDetalleServicioCliente(servicio)">
                            <span class="btn-icon">üëÅÔ∏è</span>
                            <span class="btn-text">Ver m√°s</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- B√∫squedas Recientes (solo cuando no hay categor√≠a seleccionada) -->
        <section *ngIf="!categoriaSeleccionada" class="recent-searches">
            <h3 class="recent-title">
                <i class="fas fa-clock recent-icon"></i>
                B√∫squedas Recientes
            </h3>
            <div class="search-item" (click)="buscarReciente('jardineria')">
                <div class="search-item-icon">üå±</div>
                <span class="search-item-text">Jardiner√≠a en mi zona</span>
            </div>
            <div class="search-item" (click)="buscarReciente('limpieza')">
                <div class="search-item-icon">üßπ</div>
                <span class="search-item-text">Limpieza semanal</span>
            </div>
            <div class="search-item" (click)="buscarReciente('plomeria')">
                <div class="search-item-icon">üîß</div>
                <span class="search-item-text">Plomero urgente</span>
            </div>
        </section>
    </div>

  <!-- ========== DASHBOARD PARA PROVEEDORES ========== -->
  <div *ngIf="isProveedor" class="proveedor-dashboard">
    <!-- Header del Dashboard -->
    <header class="proveedor-header">
      <div class="proveedor-title-section">
        <div class="proveedor-icon">üë∑</div>
        <div>
          <h1 class="proveedor-title">Mi Negocio</h1>
          <p class="proveedor-subtitle">Panel del Proveedor</p>
        </div>
      </div>
    </header>

    <!-- Tarjetas de Estad√≠sticas -->
    <section class="stats-section">
      <div class="stat-card">
        <div class="stat-icon services-icon">üîß</div>
        <div class="stat-content">
        <div class="stat-number">{{ proveedorStats.serviciosActivos }}</div>
        <div class="stat-label">Servicios Activos</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon contacts-icon">üìû</div>
        <div class="stat-content">
        <div class="stat-number">{{ proveedorStats.contactosEsteMes }}</div>
        <div class="stat-label">Contactos Este Mes</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon rating-icon">‚≠ê</div>
        <div class="stat-content">
          <div class="stat-number">{{ userRating || '0.0' }}</div>
          <div class="stat-label">Rating ({{ proveedorStats.totalResenas }})</div>
        </div>
      </div>
    </section>

    <!-- Bot√≥n Principal de Acci√≥n -->
    <section class="main-action-section">
      <button class="btn-main-action" (click)="routeRegistrarServicio()">
        <span class="btn-icon">‚ûï</span>
        <span class="btn-text">Publicar Nuevo Servicio</span>
      </button>
    </section>

    <!-- Mis Servicios Publicados -->
    <section class="services-list-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="title-icon">üìã</span>
          Mis Servicios Publicados
        </h2>
      </div>

    <div class="services-list" *ngIf="misServicios.length > 0; else noServices">
      <div class="service-item" *ngFor="let servicio of misServicios">
        <div class="service-item-header">
          <div class="service-item-title-section">
            <h3 class="service-item-title">{{ servicio.titulo }}</h3>
            <span class="service-item-category">{{ servicio.categoria }}</span>
          </div>
        </div>
              
        <div class="service-item-stats">
          <div class="service-stat">
            <span class="service-stat-icon">üìû</span>
            <span class="service-stat-value">{{ servicio.contactos }} contactos</span>
          </div>
        </div>
      </div>
    </div>

      <ng-template #noServices>
        <div class="empty-state">
          <div class="empty-icon">üìù</div>
          <h3 class="empty-title">No tienes servicios publicados</h3>
          <p class="empty-text">Publica tu primer servicio para que los clientes puedan encontrarte</p>
          <button class="btn-empty-action" (click)="routeRegistrarServicio()">
            ‚ûï Publicar Mi Primer Servicio
          </button>
        </div>
      </ng-template>
    </section>

    <!-- Rese√±as Recientes -->
    <section class="reviews-section">
      <div class="section-header">
        <h2 class="section-title">
          <span class="title-icon">‚≠ê</span>
          Rese√±as Recientes
        </h2>
        <button class="btn-view-all" (click)="verTodasResenas()">Ver todas ‚Üí</button>
      </div>

      <div class="reviews-list" *ngIf="ultimasResenas.length > 0; else noReviews">
        <div class="review-item" *ngFor="let resena of ultimasResenas">
          <div class="review-header">
            <div class="review-stars">{{ renderStars(resena.rating) }}</div>
            <div class="review-date">{{ resena.fecha | date:'dd/MM/yyyy' }}</div>
          </div>
          <p class="review-comment">"{{ resena.comentario }}"</p>
          <p class="review-author">- {{ resena.nombreCliente }}</p>
        </div>
      </div>

      <ng-template #noReviews>
        <div class="empty-state-small">
          <div class="empty-icon-small">üåü</div>
          <p class="empty-text-small">A√∫n no tienes rese√±as. Cuando completes servicios, los clientes podr√°n dejarte sus comentarios.</p>
        </div>
      </ng-template>
    </section>
  </div>

</main>

<!-- MODAL DE CONFIRMACI√ìN PARA CERRAR SESI√ìN -->
<div *ngIf="logoutModalVisible" class="logout-modal-overlay" (click)="closeLogoutModal()">
  <div class="logout-modal-content" (click)="$event.stopPropagation()">
    <div class="logout-modal-header">
      <div class="logout-modal-icon">
        <span class="logout-icon">üö™</span>
      </div>
      <button class="close-logout-btn" (click)="closeLogoutModal()">√ó</button>
    </div>
    
    <div class="logout-modal-body">
      <h3>¬øCerrar Sesi√≥n?</h3>
      <p>¬øEst√°s seguro de que deseas cerrar tu sesi√≥n?</p>
      <p class="logout-warning">Tendr√°s que iniciar sesi√≥n nuevamente para acceder a tu cuenta.</p>
    </div>
    
    <div class="logout-modal-footer">
      <button class="logout-btn-cancel" (click)="closeLogoutModal()">
        Cancelar
      </button>
      <button class="logout-btn-confirm" (click)="confirmLogout()">
        S√≠, Cerrar Sesi√≥n
      </button>
    </div>
  </div>
</div>
<app-chatbot-inteligente></app-chatbot-inteligente>
