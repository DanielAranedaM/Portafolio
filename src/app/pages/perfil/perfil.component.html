<div class="profile-container">

  <!-- Header del Perfil -->
  <div class="profile-header" style="position: relative;">
    <!-- BotÃ³n Editar Perfil (esquina superior derecha) -->
    <button
      class="add-photo-btn stronger"
      (click)="toggleEdit()"
      [disabled]="!dataLoaded || saving"
      title="Editar perfil"
      style="position:absolute; top: 15px; right: 15px;">
      âœï¸ Editar perfil
    </button>

    <div class="profile-photo-large">
      <!-- Imagen si existe -->
      <img *ngIf="hasProfileImage" [src]="profileImageUrl" alt="Foto de perfil grande" />
      <!-- Iniciales si no hay imagen -->
      <span *ngIf="!hasProfileImage" class="profile-initials-large">{{ userInitials }}</span>
    </div>

    <div class="profile-info">
      <h1 class="profile-name">{{ userName }}</h1>

      <!-- ClasificaciÃ³n dinÃ¡mica -->
      <div class="rating-section">
        <div class="stars">
          <ng-container *ngIf="userRating !== null && userRating > 0; else noRating">
            <ng-container *ngFor="let star of [1,2,3,4,5]">
              <span *ngIf="userRating >= star">â˜…</span>
              <span *ngIf="userRating < star && userRating >= star - 0.5">â¯¨</span>
              <span *ngIf="userRating < star - 0.5">â˜†</span>
            </ng-container>
          </ng-container>
          <ng-template #noRating>
            <span>â˜†â˜†â˜†â˜†â˜†</span>
          </ng-template>
        </div>
        <span class="rating-text">
          {{ userRating !== null ? (userRating | number:'1.1-1') : '0.0' }}
        </span>
      </div>
    </div>
  </div>

  <!-- DescripciÃ³n -->
  <div class="section">
    <h3 class="section-title">DescripciÃ³n</h3>
    <p class="description-text">
      {{ userDescription || 'â€”' }}
    </p>
  </div>

  <!-- Contacto -->
  <div class="section">
    <h3 class="section-title">Contacto</h3>
    <div class="contact-buttons">
      <button class="contact-btn whatsapp-btn" [disabled]="!userPhone">
        <span>ğŸ’¬</span>
        WhatsApp: {{ userPhone || 'sin telÃ©fono' }}
      </button>
      <button class="contact-btn call-btn" [disabled]="!userPhone">
        <span>ğŸ“</span>
        Llamar
      </button>
    </div>
  </div>

  <!-- GalerÃ­a de Fotos (SOLO proveedor) -->
  <div class="section" *ngIf="isProveedor">
    <div class="gallery-header">
      <h3 class="section-title" style="margin-bottom: 0;">GalerÃ­a de Trabajos</h3>
      <button class="add-photo-btn">
        <span>ğŸ“·</span>
        Agregar Foto
      </button>
    </div>

    <div class="photo-carousel">
      <button class="carousel-btn">â€¹</button>
      <div class="photo-grid">
        <!-- tus Ã­tems/placeholder tal como estÃ¡n -->
        <div class="photo-item">
          <span style="font-size: 24px; color: #4CAF50;">ğŸŒ±</span>
        </div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
        <div class="photo-placeholder"><span>â•</span></div>
      </div>
      <button class="carousel-btn">â€º</button>
    </div>
  </div>

  <!-- Recomendaciones -->
  <div class="section">
    <h3 class="section-title">{{ isCliente ? 'ValoraciÃ³n' : 'Recomendaciones' }}</h3>


    <div class="review-item">
      <div class="review-header">
        <span class="review-author">Elena Nito</span>
        <div class="review-rating">â˜…â˜…â˜…â˜…â˜…</div>
      </div>
      <p class="review-text">"Excelente trabajo en mi jardÃ­n. Muy profesional y puntual."</p>
      <span class="review-date">15/11/2024</span>
    </div>

    <div class="review-item">
      <div class="review-header">
        <span class="review-author">Armando Casas</span>
        <div class="review-rating">â˜…â˜…â˜…â˜…â˜…</div>
      </div>
      <p class="review-text">"Recomiendo 100%. TransformÃ³ completamente mi patio."</p>
      <span class="review-date">08/11/2024</span>
    </div>

    <div class="review-item">
      <div class="review-header">
        <span class="review-author">MarÃ­a GarcÃ­a</span>
        <div class="review-rating">â˜…â˜…â˜…â˜…â˜†</div>
      </div>
      <p class="review-text">"Muy buen servicio, cumpliÃ³ con los tiempos acordados."</p>
      <span class="review-date">02/11/2024</span>
    </div>
  </div>

  <!-- Botones de AcciÃ³n -->
  <div class="action-buttons">
    <button class="action-btn btn-primary">
      ğŸ”§ Solicitar Servicio
    </button>
    <button class="action-btn btn-secondary" (click)="goBack()">
      â† Volver al MenÃº
    </button>
    <button class="action-btn btn-danger" (click)="logout()">
      ğŸšª Cerrar SesiÃ³n
    </button>
  </div>
</div>

<!-- =================== MODAL EDICIÃ“N PERFIL =================== -->
<div
  *ngIf="editMode"
  style="
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;">

  <!-- Contenedor del modal (NO se cierra al hacer click fuera) -->
  <div
    style="
      width: min(760px, 94vw);
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      display: flex; flex-direction: column;
      max-height: 90vh;">

    <!-- Header modal -->
    <div
      style="
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: #fff; padding: 16px 20px;
        display:flex; align-items:center; justify-content:space-between;">
      <h3 style="margin:0; font-size: 18px;">Editar perfil</h3>
      <button
        class="add-photo-btn"
        (click)="toggleEdit()"
        style="background: rgba(255,255,255,0.15);">
        âœ– Cerrar
      </button>
    </div>

    <!-- Body con scroll -->
    <div style="overflow-y: auto;">
      <form
        [formGroup]="form"
        (ngSubmit)="save()"
        (keydown.enter)="$event.preventDefault()"
        style="padding: 20px;">

        <!-- Foto -->
        <div class="section" style="margin:0 0 16px 0;">
          <div class="section-title">Foto de perfil</div>
          <div style="display:flex; align-items:center; gap:16px; flex-wrap: wrap;">
            <div class="profile-photo-large" style="margin:0;">
              <img *ngIf="hasProfileImage" [src]="profileImageUrl" alt="Foto actual" />
              <span *ngIf="!hasProfileImage" class="profile-initials-large">{{ userInitials }}</span>
            </div>
            <input type="file" accept="image/*" (change)="onFilePicked($event)">
          </div>
        </div>

        <!-- Datos de usuario -->
        <div class="section" style="margin:0 0 16px 0;">
          <div class="section-title">Datos bÃ¡sicos</div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
            <div>
              <label>Nombre *</label>
              <input type="text" formControlName="nombre" maxlength="200"
                     style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                   *ngIf="form.get('nombre')?.invalid && (form.get('nombre')?.touched || form.get('nombre')?.dirty)">
                <span *ngIf="form.get('nombre')?.errors?.['required']">El nombre es requerido.</span>
                <span *ngIf="form.get('nombre')?.errors?.['maxlength']">MÃ¡ximo 200 caracteres.</span>
              </div>
            </div>

            <div>
              <label>Correo *</label>
              <input type="email" formControlName="correo" maxlength="255"
                     style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                   *ngIf="form.get('correo')?.invalid && (form.get('correo')?.touched || form.get('correo')?.dirty)">
                <span *ngIf="form.get('correo')?.errors?.['required']">El correo es requerido.</span>
                <span *ngIf="form.get('correo')?.errors?.['email']">Formato de correo invÃ¡lido.</span>
                <span *ngIf="form.get('correo')?.errors?.['maxlength']">MÃ¡ximo 255 caracteres.</span>
              </div>
            </div>

            <div>
              <label>TelÃ©fono (9 dÃ­gitos, sin +56) *</label>
              <input type="text" formControlName="telefono" inputmode="numeric" maxlength="9" placeholder="9XXXXXXXX"
                    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="form.get('telefono')?.invalid && (form.get('telefono')?.touched || form.get('telefono')?.dirty)">
                <span *ngIf="form.get('telefono')?.errors?.['required']">El telÃ©fono es requerido.</span>
                <span *ngIf="form.get('telefono')?.errors?.['pattern']">Debe tener exactamente 9 dÃ­gitos (sin +56).</span>
              </div>
            </div>

            <div style="grid-column: 1 / -1;">
              <label>DescripciÃ³n (mÃ¡x. 300)</label>

              <div class="input-with-counter">
                <textarea rows="3" formControlName="descripcion" maxlength="300"
                          style="width:100%; padding:10px 50px 36px 10px; border-radius:10px; border:1px solid #ddd;"></textarea>
                <div class="char-counter">{{ descCount }}/300</div>
              </div>

              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="form.get('descripcion')?.invalid && (form.get('descripcion')?.touched || form.get('descripcion')?.dirty || submitted)">
                <span *ngIf="form.get('descripcion')?.errors?.['maxlength']">MÃ¡ximo 300 caracteres.</span>
              </div>
            </div>

          </div>
        </div>

        <!-- DirecciÃ³n -->
        <div class="section" style="margin:0 0 16px 0; position: relative;">
          <div class="section-title">DirecciÃ³n</div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
            <div style="grid-column: 1 / -1; position: relative;">
              <label>DirecciÃ³n *</label>
              <input #dirInput
                    type="text"
                    formControlName="direccionDescripcion"
                    maxlength="300"
                    (input)="onDireccionInput(dirInput.value)"
                    (focus)="abrirSugerenciasSiHay()"
                    (blur)="cerrarSugerencias()"
                    (keydown.enter)="$event.preventDefault()"
                    autocomplete="off"
                    autocapitalize="off"
                    spellcheck="false"
                    placeholder="Busca y selecciona una sugerencia (OSM)"
                    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">

              <!-- SUGERENCIAS OSM -->
              <div *ngIf="mostrandoSugerencias"
                  style="position:absolute; left:0; right:0; top:100%; z-index:10; background:#fff; border:1px solid #ddd; border-radius:10px; max-height:220px; overflow-y:auto; box-shadow:0 6px 20px rgba(0,0,0,0.15);">
                <div *ngFor="let s of sugerencias"
                    (mousedown)="seleccionarSugerencia(s)"
                    style="padding:10px 12px; cursor:pointer; border-bottom:1px solid #f1f1f1;">
                  {{ s.display_name }}
                </div>
                <div *ngIf="sugerencias.length === 0" style="padding:10px 12px; color:#6c757d;">Sin resultados</div>
              </div>

              <!-- ValidaciÃ³n -->
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="(form.get('direccionDescripcion')?.invalid && (form.get('direccionDescripcion')?.touched || form.get('direccionDescripcion')?.dirty || submitted))">
                <span *ngIf="form.get('direccionDescripcion')?.errors?.['required']">La direcciÃ³n es requerida.</span>
                <span *ngIf="form.get('direccionDescripcion')?.errors?.['maxlength']">MÃ¡ximo 300 caracteres.</span>
              </div>
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="submitted && addressChanged && !direccionSeleccionada">
                Debes seleccionar una direcciÃ³n vÃ¡lida de las sugerencias.
              </div>

            </div>

            <div>
              <label>CÃ³digo Postal</label>
              <input type="text" formControlName="codigoPostal" maxlength="20"
                    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="form.get('codigoPostal')?.invalid && (form.get('codigoPostal')?.touched || form.get('codigoPostal')?.dirty || submitted)">
                <span *ngIf="form.get('codigoPostal')?.errors?.['maxlength']">MÃ¡ximo 20 caracteres.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div style="display:flex; gap:12px; justify-content:flex-end; margin-top: 10px;">
          <button type="button" class="action-btn btn-secondary" (click)="toggleEdit()" [disabled]="saving">Cancelar</button>
          <button type="submit" class="action-btn btn-primary" [disabled]="!dataLoaded || form.invalid || saving">
            {{ saving ? 'Guardando...' : 'ğŸ’¾ Guardar cambios' }}
          </button>
        </div>

      </form>
    </div>

  </div>
</div>
