<div class="profile-container-modern">

  <!-- Header del Perfil -->
  <div class="profile-header-modern">
    <div class="profile-photo-section">
      <div class="profile-photo-large">
        <img *ngIf="hasProfileImage" [src]="profileImageUrl" alt="Foto de perfil" />
        <span *ngIf="!hasProfileImage" class="profile-initials-large">{{ userInitials }}</span>
      </div>
    </div>

    <div class="profile-info-section">
      <h1 class="profile-name-modern">{{ userName }}</h1>
      
      <!-- Rating -->
      <div class="rating-section-modern">
        <div class="stars-modern">
          <ng-container *ngIf="userRating !== null && userRating > 0; else noRating">
            <ng-container *ngFor="let star of [1,2,3,4,5]">
              <span *ngIf="userRating >= star" class="star-filled">â˜…</span>
              <span *ngIf="userRating < star && userRating >= star - 0.5" class="star-half">â¯¨</span>
              <span *ngIf="userRating < star - 0.5" class="star-empty">â˜†</span>
            </ng-container>
          </ng-container>
          <ng-template #noRating>
            <span class="star-empty">â˜†â˜†â˜†â˜†â˜†</span>
          </ng-template>
        </div>
        <span class="rating-text-modern">
          {{ userRating !== null ? (userRating | number:'1.1-1') : '0.0' }}
        </span>
      </div>
    </div>

    <!-- BotÃ³n de configuraciÃ³n mÃ¡s claro -->
    <button 
      *ngIf="!isPublicProfile"
      class="config-btn-clear-modern" 
      (click)="toggleEdit()"
      [disabled]="!dataLoaded || saving"
      title="Editar mis datos">
      <i class="config-icon">âš™ï¸</i>
      <span class="config-text">Editar Perfil</span>
    </button>
  </div>

  <!-- DescripciÃ³n fuera del header -->
  <div class="description-section-separate">
    <div class="section-header-simple">
      <h2 class="section-title-simple">
        <i class="section-icon">ğŸ“</i>
        Sobre mÃ­
      </h2>
    </div>
    
    <div *ngIf="!editingDescription" class="description-display-separate" (click)="!isPublicProfile && startEditDescription()">
      <p class="description-text-separate">
        {{ userDescription || 'CuÃ©ntanos sobre tu experiencia, especialidades y lo que te hace Ãºnico...' }}
      </p>
      <div class="edit-hint-modern" *ngIf="!isPublicProfile">
        <i class="edit-icon-modern">âœï¸</i>
        <span>Haz clic para editar</span>
      </div>
    </div>
    
    <div *ngIf="editingDescription" class="description-edit-separate">
      <textarea 
        [(ngModel)]="tempDescription" 
        placeholder="Describe tu experiencia, especialidades y lo que te hace Ãºnico como profesional..."
        maxlength="300"
        class="description-textarea-separate">
      </textarea>
      <div class="edit-actions-separate">
        <button (click)="saveDescription()" class="btn-save-separate">
          <i>âœ“</i> Guardar Cambios
        </button>
        <button (click)="cancelEditDescription()" class="btn-cancel-separate">
          <i>âœ—</i> Cancelar
        </button>
      </div>
      <div class="char-counter-separate">{{ (tempDescription || '').length }}/300 caracteres</div>
    </div>
  </div>

  <!-- Contacto Simplificado -->
  <div class="contact-section-modern">
    <div class="contact-card">
      <i class="contact-icon">ğŸ’¬</i>
      <div class="contact-info">
        <span class="contact-label">WhatsApp</span>
        <span class="contact-value">{{ userPhone || 'No registrado' }}</span>
      </div>
      <button 
        class="contact-btn-modern whatsapp" 
        [disabled]="!userPhone"
        (click)="openWhatsApp()">
        Contactar
      </button>
    </div>
  </div>

  <!-- GalerÃ­a de Trabajos -->
  <div class="gallery-section-modern" *ngIf="isProveedor">
    <div class="section-header-modern">
      <h2 class="section-title-modern">
        <i class="section-icon">ğŸ–¼ï¸</i>
        GalerÃ­a de Trabajos
      </h2>
      <button class="add-photo-btn-modern" (click)="addPhoto()" *ngIf="!isPublicProfile">
        ğŸ“· Agregar Foto
      </button>
    </div>

    <div *ngIf="galleryPhotos.length > 0; else noPhotos" class="gallery-grid-modern">
      <div *ngFor="let photo of galleryPhotos; let i = index" class="gallery-item-modern">
        <img [src]="photo.url" [alt]="photo.description" class="gallery-image">
        <div class="gallery-overlay">
          <button class="gallery-action delete" (click)="removePhoto(i)" *ngIf="!isPublicProfile">ğŸ—‘ï¸</button>
          <button class="gallery-action view" (click)="viewPhoto(photo)">ğŸ”</button>
        </div>
      </div>
    </div>

    <ng-template #noPhotos>
      <div class="empty-state-modern gallery-empty">
        <i class="empty-icon">ğŸ“¸</i>
        <h3>No hay fotos de trabajos</h3>
        <p *ngIf="!isPublicProfile">Agrega fotos de tus trabajos para que los clientes vean la calidad de tu trabajo</p>
        <button class="btn-primary-modern" (click)="addPhoto()" *ngIf="!isPublicProfile">
          ğŸ“· Subir Primera Foto
        </button>
      </div>
    </ng-template>
  </div>

  <!-- Botones de AcciÃ³n -->
  <div class="action-buttons-modern">
    <button class="action-btn-modern primary" *ngIf="isProveedor && !isPublicProfile" (click)="goToRegisterService()">
      â• Publicar Servicio
    </button>
    <button class="action-btn-modern secondary" (click)="goBack()">
      â† Volver al MenÃº
    </button>
  </div>
</div>

<!-- =================== MODAL EDICIÃ“N PERFIL =================== -->
<div
  *ngIf="editMode"
  style="
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;">

  <!-- Contenedor del modal (NO se cierra al hacer click fuera) -->
  <div
    style="
      width: min(760px, 94vw);
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      display: flex; flex-direction: column;
      max-height: 90vh;">

    <!-- Header modal -->
    <div
      style="
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: #fff; padding: 16px 20px;
        display:flex; align-items:center; justify-content:space-between;">
      <h3 style="margin:0; font-size: 18px;">Editar perfil</h3>
      <button
        class="add-photo-btn"
        (click)="toggleEdit()"
        style="background: rgba(255,255,255,0.15);">
        âœ– Cerrar
      </button>
    </div>

    <!-- Body con scroll -->
    <div style="overflow-y: auto;">
      <form
        [formGroup]="form"
        (ngSubmit)="save()"
        (keydown.enter)="$event.preventDefault()"
        style="padding: 20px;">

        <!-- Foto -->
        <div class="section" style="margin:0 0 16px 0;">
          <div class="section-title">Foto de perfil</div>
          <div style="display:flex; align-items:center; gap:16px; flex-wrap: wrap;">
            <div class="profile-photo-large" style="margin:0;">
              <img *ngIf="hasProfileImage" [src]="profileImageUrl" alt="Foto actual" />
              <span *ngIf="!hasProfileImage" class="profile-initials-large">{{ userInitials }}</span>
            </div>
            <input type="file" accept="image/*" (change)="onFilePicked($event)">
          </div>
        </div>

        <!-- Datos de usuario -->
        <div class="section" style="margin:0 0 16px 0;">
          <div class="section-title">Datos bÃ¡sicos</div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
            <div>
              <label>Nombre *</label>
              <input type="text" formControlName="nombre" maxlength="200"
                     style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                   *ngIf="form.get('nombre')?.invalid && (form.get('nombre')?.touched || form.get('nombre')?.dirty)">
                <span *ngIf="form.get('nombre')?.errors?.['required']">El nombre es requerido.</span>
                <span *ngIf="form.get('nombre')?.errors?.['maxlength']">MÃ¡ximo 200 caracteres.</span>
              </div>
            </div>

            <div>
              <label>Correo *</label>
              <input type="email" formControlName="correo" maxlength="255"
                     style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                   *ngIf="form.get('correo')?.invalid && (form.get('correo')?.touched || form.get('correo')?.dirty)">
                <span *ngIf="form.get('correo')?.errors?.['required']">El correo es requerido.</span>
                <span *ngIf="form.get('correo')?.errors?.['email']">Formato de correo invÃ¡lido.</span>
                <span *ngIf="form.get('correo')?.errors?.['maxlength']">MÃ¡ximo 255 caracteres.</span>
              </div>
            </div>

            <div>
              <label>TelÃ©fono (9 dÃ­gitos, sin +56) *</label>
              <input type="text" formControlName="telefono" inputmode="numeric" maxlength="9" placeholder="9XXXXXXXX"
                    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="form.get('telefono')?.invalid && (form.get('telefono')?.touched || form.get('telefono')?.dirty)">
                <span *ngIf="form.get('telefono')?.errors?.['required']">El telÃ©fono es requerido.</span>
                <span *ngIf="form.get('telefono')?.errors?.['pattern']">Debe tener exactamente 9 dÃ­gitos (sin +56).</span>
              </div>
            </div>

            <div style="grid-column: 1 / -1;">
              <label>DescripciÃ³n (mÃ¡x. 300)</label>

              <div class="input-with-counter">
                <textarea rows="3" formControlName="descripcion" maxlength="300"
                          style="width:100%; padding:10px 50px 36px 10px; border-radius:10px; border:1px solid #ddd;"></textarea>
                <div class="char-counter">{{ descCount }}/300</div>
              </div>

              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="form.get('descripcion')?.invalid && (form.get('descripcion')?.touched || form.get('descripcion')?.dirty || submitted)">
                <span *ngIf="form.get('descripcion')?.errors?.['maxlength']">MÃ¡ximo 300 caracteres.</span>
              </div>
            </div>

          </div>
        </div>

        <!-- DirecciÃ³n -->
        <div class="section" style="margin:0 0 16px 0; position: relative;">
          <div class="section-title">DirecciÃ³n</div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
            <div style="grid-column: 1 / -1; position: relative;">
              <label>DirecciÃ³n *</label>
              <input #dirInput
                    type="text"
                    formControlName="direccionDescripcion"
                    maxlength="300"
                    (input)="onDireccionInput(dirInput.value)"
                    (focus)="abrirSugerenciasSiHay()"
                    (blur)="cerrarSugerencias()"
                    (keydown.enter)="$event.preventDefault()"
                    autocomplete="off"
                    autocapitalize="off"
                    spellcheck="false"
                    placeholder="Busca y selecciona una sugerencia (OSM)"
                    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">

              <!-- SUGERENCIAS OSM -->
              <div *ngIf="mostrandoSugerencias"
                  style="position:absolute; left:0; right:0; top:100%; z-index:10; background:#fff; border:1px solid #ddd; border-radius:10px; max-height:220px; overflow-y:auto; box-shadow:0 6px 20px rgba(0,0,0,0.15);">
                <div *ngFor="let s of sugerencias"
                    (mousedown)="seleccionarSugerencia(s)"
                    style="padding:10px 12px; cursor:pointer; border-bottom:1px solid #f1f1f1;">
                  {{ s.display_name }}
                </div>
                <div *ngIf="sugerencias.length === 0" style="padding:10px 12px; color:#6c757d;">Sin resultados</div>
              </div>

              <!-- ValidaciÃ³n -->
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="(form.get('direccionDescripcion')?.invalid && (form.get('direccionDescripcion')?.touched || form.get('direccionDescripcion')?.dirty || submitted))">
                <span *ngIf="form.get('direccionDescripcion')?.errors?.['required']">La direcciÃ³n es requerida.</span>
                <span *ngIf="form.get('direccionDescripcion')?.errors?.['maxlength']">MÃ¡ximo 300 caracteres.</span>
              </div>
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="submitted && addressChanged && !direccionSeleccionada">
                Debes seleccionar una direcciÃ³n vÃ¡lida de las sugerencias.
              </div>

            </div>

            <div>
              <label>CÃ³digo Postal</label>
              <input type="text" formControlName="codigoPostal" maxlength="20"
                    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="form.get('codigoPostal')?.invalid && (form.get('codigoPostal')?.touched || form.get('codigoPostal')?.dirty || submitted)">
                <span *ngIf="form.get('codigoPostal')?.errors?.['maxlength']">MÃ¡ximo 20 caracteres.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div style="display:flex; gap:12px; justify-content:flex-end; margin-top: 10px;">
          <button type="button" class="action-btn btn-secondary" (click)="toggleEdit()" [disabled]="saving">Cancelar</button>
          <button type="submit" class="action-btn btn-primary" [disabled]="!dataLoaded || form.invalid || saving">
            {{ saving ? 'Guardando...' : 'ğŸ’¾ Guardar cambios' }}
          </button>
        </div>

      </form>
    </div>

  </div>
</div>
