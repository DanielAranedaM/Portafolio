<div class="profile-container-modern">

  <!-- Header del Perfil -->
  <div class="profile-header-modern">
    <div class="profile-photo-section">
      <div class="profile-photo-large">
        <img *ngIf="hasProfileImage" [src]="profileImageUrl" alt="Foto de perfil" />
        <span *ngIf="!hasProfileImage" class="profile-initials-large">{{ userInitials }}</span>
      </div>
    </div>

    <div class="profile-info-section">
      <h1 class="profile-name-modern">{{ userName }}</h1>
      
      <!-- Rating -->
      <div class="rating-section-modern">
        <div class="stars-modern">
          <ng-container *ngIf="userRating !== null && userRating > 0; else noRating">
            <ng-container *ngFor="let star of [1,2,3,4,5]">
              <i *ngIf="userRating >= star" class="bi bi-star-fill star-filled"></i>
              <i *ngIf="userRating < star && userRating >= star - 0.5" class="bi bi-star-half star-half"></i>
              <i *ngIf="userRating < star - 0.5" class="bi bi-star star-empty"></i>
            </ng-container>
          </ng-container>
          <ng-template #noRating>
            <i class="bi bi-star star-empty"></i>
            <i class="bi bi-star star-empty"></i>
            <i class="bi bi-star star-empty"></i>
            <i class="bi bi-star star-empty"></i>
            <i class="bi bi-star star-empty"></i>
          </ng-template>
        </div>
        <span class="rating-text-modern">
          {{ userRating !== null ? (userRating | number:'1.1-1') : '0.0' }}
        </span>
      </div>
    </div>

    <!-- Bot√≥n de configuraci√≥n m√°s claro -->
    <button 
      *ngIf="!isPublicProfile"
      class="config-btn-clear-modern" 
      (click)="toggleEdit()"
      [disabled]="!dataLoaded || saving"
      title="Editar mis datos">
      <i class="config-icon">‚öôÔ∏è</i>
      <span class="config-text">Editar Perfil</span>
    </button>
  </div>

  <!-- Descripci√≥n fuera del header -->
  <div class="description-section-separate">
    <div class="section-header-simple">
      <h2 class="section-title-simple">
        <i class="section-icon">üìù</i>
        Sobre m√≠
      </h2>
    </div>
    
    <div *ngIf="!editingDescription" class="description-display-separate" (click)="!isPublicProfile && startEditDescription()">
      <p class="description-text-separate">
        {{ userDescription || 'Cu√©ntanos sobre tu experiencia, especialidades y lo que te hace √∫nico...' }}
      </p>
      <div class="edit-hint-modern" *ngIf="!isPublicProfile">
        <i class="edit-icon-modern">‚úèÔ∏è</i>
        <span>Haz clic para editar</span>
      </div>
    </div>
    
    <div *ngIf="editingDescription" class="description-edit-separate">
      <textarea 
        [(ngModel)]="tempDescription" 
        placeholder="Describe tu experiencia, especialidades y lo que te hace √∫nico como profesional..."
        maxlength="300"
        class="description-textarea-separate">
      </textarea>
      <div class="edit-actions-separate">
        <button (click)="saveDescription()" class="btn-save-separate">
          <i>‚úì</i> Guardar Cambios
        </button>
        <button (click)="cancelEditDescription()" class="btn-cancel-separate">
          <i>‚úó</i> Cancelar
        </button>
      </div>
      <div class="char-counter-separate">{{ (tempDescription || '').length }}/300 caracteres</div>
    </div>
  </div>

  <!-- Contacto Simplificado -->
  <div class="contact-section-modern">
    <div class="contact-card">
      <i class="contact-icon">üí¨</i>
      <div class="contact-info">
        <span class="contact-label">WhatsApp</span>
        <span class="contact-value">{{ userPhone || 'No registrado' }}</span>
      </div>
      <button 
        class="contact-btn-modern whatsapp" 
        [disabled]="!userPhone"
        (click)="openWhatsApp()">
        Contactar
      </button>
    </div>
  </div>

  <!-- Galer√≠a de Trabajos (Reemplazado por Servicios Publicados) -->
  <div class="gallery-section-modern" *ngIf="isProveedor">
    <div class="section-header-modern">
      <h2 class="section-title-modern">
        <i class="section-icon">üíº</i>
        Servicios Publicados
      </h2>
      <button class="add-photo-btn-modern" (click)="goToRegisterService()" *ngIf="!isPublicProfile">
        ‚ûï Publicar Servicio
      </button>
    </div>

    <div *ngIf="userServices.length > 0; else noServices" class="gallery-grid-modern">
      <div *ngFor="let service of userServices" class="gallery-item-modern" style="position: relative; overflow: hidden;">
        <img [src]="service.urlFoto" [alt]="service.titulo" class="gallery-image" style="width: 100%; height: 100%; object-fit: cover;">
        
        <!-- Informaci√≥n del servicio -->
        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; padding: 12px; pointer-events: none;">
            <div style="font-weight: bold; font-size: 1.1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">{{ service.titulo }}</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">{{ service.categoria }}</div>
        </div>
      </div>
    </div>

    <ng-template #noServices>
      <div class="empty-state-modern gallery-empty">
        <i class="empty-icon">üíº</i>
        <h3>No hay servicios publicados</h3>
        <p *ngIf="!isPublicProfile">Publica tus servicios para que los clientes puedan encontrarte.</p>
        <button class="btn-primary-modern" (click)="goToRegisterService()" *ngIf="!isPublicProfile">
          ‚ûï Publicar Primer Servicio
        </button>
      </div>
    </ng-template>
  </div>

  <!-- Botones de Acci√≥n -->
  <div class="action-buttons-modern">
    <button class="action-btn-modern primary" *ngIf="isProveedor && !isPublicProfile" (click)="goToRegisterService()">
      ‚ûï Publicar Servicio
    </button>
    <button class="action-btn-modern secondary" (click)="goBack()">
      ‚Üê Volver al Men√∫
    </button>
  </div>
</div>

<!-- =================== MODAL EDICI√ìN PERFIL =================== -->
<div
  *ngIf="editMode"
  style="
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;">

  <!-- Contenedor del modal -->
  <div
    style="
      width: min(760px, 94vw);
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      display: flex; flex-direction: column;
      max-height: 90vh;">

    <!-- Header modal -->
    <div
      style="
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: #fff; padding: 16px 20px;
        display:flex; align-items:center; justify-content:space-between;">
      <h3 style="margin:0; font-size: 18px;">Editar perfil</h3>
      <button
        class="add-photo-btn"
        (click)="toggleEdit()"
        style="background: rgba(255,255,255,0.15);">
        ‚úñ Cerrar
      </button>
    </div>

    <!-- Body con scroll -->
    <div style="overflow-y: auto;">
      <form
        [formGroup]="form"
        (ngSubmit)="save()"
        (keydown.enter)="$event.preventDefault()"
        style="padding: 20px;">

        <!-- Foto -->
        <div class="section" style="margin:0 0 16px 0;">
          <div class="section-title">Foto de perfil</div>
          <div style="display:flex; align-items:center; gap:16px; flex-wrap: wrap;">
            <div class="profile-photo-large" style="margin:0;">
              <img *ngIf="hasProfileImage" [src]="profileImageUrl" alt="Foto actual" />
              <span *ngIf="!hasProfileImage" class="profile-initials-large">{{ userInitials }}</span>
            </div>
            <input type="file" accept="image/*" (change)="onFilePicked($event)">
          </div>
        </div>

        <!-- Datos de usuario -->
        <div class="section" style="margin:0 0 16px 0;">
          <div class="section-title">Datos b√°sicos</div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
            <div>
              <label>Nombre *</label>
              <input type="text" formControlName="nombre" maxlength="200"
                     style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                   *ngIf="form.get('nombre')?.invalid && (form.get('nombre')?.touched || form.get('nombre')?.dirty)">
                <span *ngIf="form.get('nombre')?.errors?.['required']">El nombre es requerido.</span>
                <span *ngIf="form.get('nombre')?.errors?.['maxlength']">M√°ximo 200 caracteres.</span>
              </div>
            </div>

            <div>
              <label>Correo *</label>
              <input type="email" formControlName="correo" maxlength="255"
                     style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                   *ngIf="form.get('correo')?.invalid && (form.get('correo')?.touched || form.get('correo')?.dirty)">
                <span *ngIf="form.get('correo')?.errors?.['required']">El correo es requerido.</span>
                <span *ngIf="form.get('correo')?.errors?.['email']">Formato de correo inv√°lido.</span>
                <span *ngIf="form.get('correo')?.errors?.['maxlength']">M√°ximo 255 caracteres.</span>
              </div>
            </div>

            <div>
              <label>Tel√©fono (9 d√≠gitos, sin +56) *</label>
              <input type="text" formControlName="telefono" inputmode="numeric" maxlength="9" placeholder="9XXXXXXXX"
                    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="form.get('telefono')?.invalid && (form.get('telefono')?.touched || form.get('telefono')?.dirty)">
                <span *ngIf="form.get('telefono')?.errors?.['required']">El tel√©fono es requerido.</span>
                <span *ngIf="form.get('telefono')?.errors?.['pattern']">Debe tener exactamente 9 d√≠gitos (sin +56).</span>
              </div>
            </div>

            <div style="grid-column: 1 / -1;">
              <label>Descripci√≥n (m√°x. 300)</label>

              <div class="input-with-counter">
                <textarea rows="3" formControlName="descripcion" maxlength="300"
                          style="width:100%; padding:10px 50px 36px 10px; border-radius:10px; border:1px solid #ddd;"></textarea>
                <div class="char-counter">{{ descCount }}/300</div>
              </div>

              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="form.get('descripcion')?.invalid && (form.get('descripcion')?.touched || form.get('descripcion')?.dirty || submitted)">
                <span *ngIf="form.get('descripcion')?.errors?.['maxlength']">M√°ximo 300 caracteres.</span>
              </div>
            </div>

          </div>
        </div>

        <!-- Direcci√≥n -->
        <div class="section" style="margin:0 0 16px 0; position: relative;">
          <div class="section-title">Direcci√≥n</div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
            <div style="grid-column: 1 / -1; position: relative;">
              <label>Direcci√≥n *</label>
              <input #dirInput
                    type="text"
                    formControlName="direccionDescripcion"
                    maxlength="300"
                    (input)="onDireccionInput(dirInput.value)"
                    (focus)="abrirSugerenciasSiHay()"
                    (blur)="cerrarSugerencias()"
                    (keydown.enter)="$event.preventDefault()"
                    autocomplete="off"
                    autocapitalize="off"
                    spellcheck="false"
                    placeholder="Busca y selecciona una sugerencia (OSM)"
                    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">

              <!-- SUGERENCIAS OSM -->
              <div *ngIf="mostrandoSugerencias"
                  style="position:absolute; left:0; right:0; top:100%; z-index:10; background:#fff; border:1px solid #ddd; border-radius:10px; max-height:220px; overflow-y:auto; box-shadow:0 6px 20px rgba(0,0,0,0.15);">
                <div *ngFor="let s of sugerencias"
                    (mousedown)="seleccionarSugerencia(s)"
                    style="padding:10px 12px; cursor:pointer; border-bottom:1px solid #f1f1f1;">
                  {{ s.display_name }}
                </div>
                <div *ngIf="sugerencias.length === 0" style="padding:10px 12px; color:#6c757d;">Sin resultados</div>
              </div>

              <!-- Validaci√≥n -->
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="(form.get('direccionDescripcion')?.invalid && (form.get('direccionDescripcion')?.touched || form.get('direccionDescripcion')?.dirty || submitted))">
                <span *ngIf="form.get('direccionDescripcion')?.errors?.['required']">La direcci√≥n es requerida.</span>
                <span *ngIf="form.get('direccionDescripcion')?.errors?.['maxlength']">M√°ximo 300 caracteres.</span>
              </div>
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="submitted && addressChanged && !direccionSeleccionada">
                Debes seleccionar una direcci√≥n v√°lida de las sugerencias.
              </div>

            </div>

            <div>
              <label>C√≥digo Postal</label>
              <input type="text" formControlName="codigoPostal" maxlength="20"
                    style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
              <div class="description-text" style="color:#f44336; margin-top:6px;"
                  *ngIf="form.get('codigoPostal')?.invalid && (form.get('codigoPostal')?.touched || form.get('codigoPostal')?.dirty || submitted)">
                <span *ngIf="form.get('codigoPostal')?.errors?.['maxlength']">M√°ximo 20 caracteres.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div style="display:flex; gap:12px; justify-content:flex-end; margin-top: 10px;">
          <button type="button" class="action-btn btn-secondary" (click)="toggleEdit()" [disabled]="saving">Cancelar</button>
          <button type="submit" class="action-btn btn-primary" [disabled]="!dataLoaded || form.invalid || saving">
            {{ saving ? 'Guardando...' : 'üíæ Guardar cambios' }}
          </button>
        </div>

      </form>
    </div>

  </div>
</div>
