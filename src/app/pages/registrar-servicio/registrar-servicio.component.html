
<div class="rs-main-bg">
  <div class="rs-card">
    <div class="rs-header">
      <span class="rs-icon">üõ†Ô∏è</span>
      <div>
        <h1>Registrar Servicio</h1>
        <p class="rs-subtitle">Publica tu servicio en 3 simples pasos</p>
      </div>
    </div>

    <!-- Stepper visual mejorado -->
    <div class="step-indicator d-flex justify-content-center mb-4">
      <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <span class="step-number"><i class="bi bi-1-circle"></i> 1</span>
        <span class="step-label">Informaci√≥n B√°sica</span>
      </div>
      <div class="step-line"></div>
      <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <span class="step-number"><i class="bi bi-2-circle"></i> 2</span>
        <span class="step-label">Detalles</span>
      </div>
      <div class="step-line"></div>
      <div class="step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
        <span class="step-number"><i class="bi bi-3-circle"></i> 3</span>
        <span class="step-label">Im√°genes</span>
      </div>
    </div>

    <form [formGroup]="form" (ngSubmit)="submit()">
      <!-- Paso 1 -->
      <div *ngIf="currentStep === 1" class="step-content">
        <h3><i class="bi bi-info-circle"></i> Informaci√≥n B√°sica</h3>
        <div class="mb-3">
          <label for="nombreServicio" class="form-label">Nombre del Servicio</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-pencil"></i></span>
            <input type="text" class="form-control form-control-lg" id="nombreServicio" formControlName="nombreServicio" placeholder="Ej: Limpieza del hogar">
          </div>
          <div *ngIf="form.get('nombreServicio')?.invalid && form.get('nombreServicio')?.touched" class="text-danger">
            <i class="bi bi-exclamation-circle"></i> Nombre requerido (m√≠nimo 3 caracteres)
          </div>
        </div>
        <div class="mb-3">
          <label for="categoria" class="form-label">Categor√≠a</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-tags"></i></span>
            <select class="form-select form-select-lg" id="categoria" formControlName="categoria">
              <option value="">Selecciona una categor√≠a</option>
              <option *ngFor="let c of categorias" [value]="c.idCategoriaServicio">
                {{ c.nombre }}
              </option>
            </select>
          </div>
          <div *ngIf="cargandoCategorias" class="form-text">Cargando categor√≠as‚Ä¶</div>
          <div *ngIf="form.get('categoria')?.invalid && form.get('categoria')?.touched" class="text-danger">
            <i class="bi bi-exclamation-circle"></i> Categor√≠a requerida
          </div>
        </div>
      </div>

      <!-- Paso 2 -->
      <div *ngIf="currentStep === 2" class="step-content">
        <h3><i class="bi bi-list-check"></i> Detalles del Servicio</h3>
        <div class="mb-3">
          <label for="descripcion" class="form-label">Descripci√≥n</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-card-text"></i></span>
            <textarea
              class="form-control form-control-lg"
              id="descripcion"
              formControlName="descripcion"
              rows="7"
              placeholder="Escribe con detalle qu√© har√°s, qu√© incluye y qu√© no incluye. Agrega precios por tramo (ej: 10 m¬≤, 50 m¬≤), tiempos aproximados y si llevas tus materiales."
            ></textarea>
          </div>
          <div class="rs-char-counter" aria-live="polite">
            {{ (form.value.descripcion?.length || 0) }} caracteres escritos ‚Äì Sugerencia: apunta a 120‚Äì200 para una mejor comprensi√≥n.
          </div>
          <div *ngIf="form.get('descripcion')?.invalid && form.get('descripcion')?.touched" class="text-danger">
            <i class="bi bi-exclamation-circle"></i> Descripci√≥n requerida (m√≠nimo 10 caracteres)
          </div>
        </div>

        <!-- Tip amigable para adultos mayores -->
        <div class="rs-tip" role="note" aria-label="Consejos para describir el servicio">
          <div class="rs-tip-title">
            <i class="bi bi-lightbulb"></i>
            Consejos para describir muy bien tu servicio
          </div>
          <ul class="rs-tip-list">
            <li>
              Explica en palabras simples qu√© har√°s y en qu√© lugares lo realizas
              (ej.: casa, jard√≠n, condominio, departamento sin ascensor).
            </li>
            <li>
              Detalla qu√© incluye y qu√© no incluye. Ej.: ‚ÄúIncluye: corte, orillado y limpieza b√°sica; No incluye: retiro de escombros‚Äù.
            </li>
            <li>
              Indica precios por tramos o tama√±os para evitar confusiones.
              Tambi√©n puedes indicar precio por hora y precio m√≠nimo de visita.
            </li>
            <li>
              Se√±ala si llevas tus materiales y herramientas, o si los debe tener el cliente.
            </li>
            <li>
              Agrega tiempos aproximados y disponibilidad (d√≠as y horarios).
            </li>
            <li>
              Escribe el radio de atenci√≥n (ej.: dentro de 5 km de mi domicilio).
            </li>
          </ul>

          <div class="rs-examples">
            <div class="rs-example-card">
              <div class="rs-example-title"><i class="bi bi-scissors"></i> Corte de pasto</div>
              <ul>
                <li>Hasta 10 m¬≤: $10.000</li>
                <li>Hasta 50 m¬≤: $30.000</li>
                <li>M√°s de 50 m¬≤: a conversar seg√∫n tama√±o</li>
              </ul>
              <div class="rs-example-note">Incluye orillado y barrido simple. No incluye retiro de sacos.</div>
            </div>
            <div class="rs-example-card">
              <div class="rs-example-title"><i class="bi bi-brush"></i> Pintura de habitaci√≥n</div>
              <ul>
                <li>Hasta 9 m¬≤: $35.000 (mano de obra)</li>
                <li>10‚Äì20 m¬≤: $60.000</li>
              </ul>
              <div class="rs-example-note">Materiales a cargo del cliente, puedo asesorar en la compra.</div>
            </div>
            <div class="rs-example-card">
              <div class="rs-example-title"><i class="bi bi-lightning"></i> Cambio de ampolletas</div>
              <ul>
                <li>1 unidad: $5.000</li>
                <li>2‚Äì5 unidades: $12.000</li>
              </ul>
              <div class="rs-example-note">No incluye ampolletas. Tiempo aprox.: 15‚Äì30 min.</div>
            </div>
          </div>

          <div class="rs-template">
            <div class="rs-template-title"><i class="bi bi-card-checklist"></i> Plantilla sugerida</div>
            <ol>
              <li><strong>Incluye:</strong> ‚Ä¶</li>
              <li><strong>No incluye:</strong> ‚Ä¶</li>
              <li><strong>Precios por tramo:</strong> ‚Ä¶</li>
              <li><strong>Materiales/herramientas:</strong> ‚Ä¶</li>
              <li><strong>Tiempo aproximado:</strong> ‚Ä¶</li>
              <li><strong>Disponibilidad y sector:</strong> ‚Ä¶</li>
            </ol>
          </div>
        </div>
      </div>

      <!-- Paso 3 -->
      <div *ngIf="currentStep === 3" class="step-content">
        <h3><i class="bi bi-image"></i> Im√°genes y Confirmaci√≥n</h3>
        <div class="mb-3" style="position: relative;">
          <label for="ubicacion" class="form-label">Ubicaci√≥n (desde tu perfil)</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
            <input
              #direccionInput
              type="text"
              class="form-control form-control-lg"
              id="ubicacion"
              autocomplete="off"
              placeholder="Escribe tu direcci√≥n"
              (keydown.enter)="$event.preventDefault()"
              (input)="onDireccionInput(direccionInput.value)"
              (focus)="abrirSugerenciasSiHay()"
              (blur)="onDireccionBlur()"
              [value]="form.value.direccionDescripcion || ''"
            />
          </div>
          <small class="text-muted">Puedes usar tu direcci√≥n precargada o escribir una nueva.</small>
          <ul class="list-group sugerencias" *ngIf="mostrandoSugerencias">
            <li
              class="list-group-item sugerencia-item"
              *ngFor="let s of sugerencias"
              (mousedown)="seleccionarSugerencia(s, direccionInput)"
            >
              {{ s.display_name }}
            </li>
            <li class="list-group-item sugerencia-atribucion">
              Resultados por Nominatim ‚Äî ¬© OpenStreetMap contributors
            </li>
          </ul>
        </div>

        <div class="mb-3">
          <label for="imagenes" class="form-label">Adjuntar Im√°genes del Servicio</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-images"></i></span>
            <input
              type="file"
              class="form-control form-control-lg"
              id="imagenes"
              multiple
              accept="image/*"
              (change)="onFileSelected($event)"
            />
          </div>
          <small class="text-muted">Puedes seleccionar m√∫ltiples im√°genes (m√°x. 5)</small>
          <div *ngIf="selectedFiles.length > 0" class="mt-3">
            <h6>Im√°genes seleccionadas:</h6>
            <div class="rs-img-preview">
              <div *ngFor="let file of selectedFiles; let i = index" class="rs-img-item">
                <span class="rs-img-name"><i class="bi bi-file-image"></i> {{ file.name }}</span>
                <span class="rs-img-size">({{ (file.size / 1024 / 1024).toFixed(2) }} MB)</span>
                <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeFile(i)"><i class="bi bi-trash"></i></button>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <h5><i class="bi bi-clipboard-data"></i> Resumen:</h5>
          <div class="rs-resumen">
            <p><i class="bi bi-pencil"></i> <strong>Nombre:</strong> {{ form.value.nombreServicio }}</p>
            <p><i class="bi bi-tags"></i> <strong>Categor√≠a:</strong> {{ form.value.categoria }}</p>
            <p><i class="bi bi-card-text"></i> <strong>Descripci√≥n:</strong> {{ form.value.descripcion }}</p>
            <p><i class="bi bi-currency-dollar"></i> <strong>Precio:</strong> {{ form.value.precio }}</p>
            <p><i class="bi bi-geo-alt"></i> <strong>Ubicaci√≥n:</strong> {{ form.value.direccionDescripcion }}</p>
            <p><i class="bi bi-images"></i> <strong>Im√°genes:</strong> {{ selectedFiles.length }} seleccionadas</p>
          </div>
        </div>
      </div>

      <!-- Navegaci√≥n -->
      <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-secondary btn-lg" (click)="prevStep()" [disabled]="currentStep === 1"><i class="bi bi-arrow-left"></i> Anterior</button>
        <button type="button" class="btn btn-primary btn-lg" (click)="nextStep()" [disabled]="!isStepValid(currentStep)" *ngIf="currentStep < totalSteps">Siguiente <i class="bi bi-arrow-right"></i></button>
        <button type="submit" class="btn btn-success btn-lg" [disabled]="!form.valid" *ngIf="currentStep === totalSteps"><i class="bi bi-check-circle"></i> Registrar Servicio</button>
      </div>
    </form>
  </div>
</div>
