<div class="rs-bg">
  <div class="rs-container">
    
    <!-- Navegación superior -->
    <div class="rs-top-nav">
      <button class="rs-back-link" (click)="goBackToMenu()">
        <i class="bi bi-arrow-left-circle-fill"></i> Volver al Menú
      </button>
    </div>

    <!-- Header moderno -->
    <div class="rs-header-modern">
      <div class="rs-header-content">
        <div class="rs-icon-circle">
          <i class="bi bi-tools"></i>
        </div>
        <div class="rs-header-text">
          <h1>Registrar Servicio</h1>
          <p class="rs-subtitle">Publica tu servicio en 3 pasos simples y claros</p>
        </div>
      </div>
      <!-- Decoración visual -->
      <div class="rs-header-bg-shape"></div>
    </div>

    <!-- Stepper horizontal prominente -->
    <div class="rs-stepper-wide">
      <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <span class="step-number">1</span>
        <span class="step-label">Información Básica</span>
        <div class="step-line"></div>
      </div>
      <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <span class="step-number">2</span>
        <span class="step-label">Detalles del Servicio</span>
        <div class="step-line"></div>
      </div>
      <div class="step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
        <span class="step-number">3</span>
        <span class="step-label">Imágenes y Ubicación</span>
      </div>
    </div>

    <!-- Formulario distribuido -->
    <form [formGroup]="form" (ngSubmit)="submit()" class="rs-form-wide">
      
      <!-- PASO 1: Información Básica -->
      <section *ngIf="currentStep === 1" class="rs-section">
        <h2 class="rs-section-title">
          <i class="bi bi-info-circle"></i>
          Información Básica del Servicio
        </h2>
        
        <div class="rs-row">
          <div class="rs-col">
            <label for="nombreServicio" class="form-label-xl">¿Cuál es el nombre de tu servicio?</label>
            <input 
              type="text" 
              class="form-control-xl" 
              id="nombreServicio" 
              formControlName="nombreServicio" 
              placeholder="Ejemplo: Limpieza del hogar, Jardinería, Plomería"
            >
            <div *ngIf="form.get('nombreServicio')?.invalid && form.get('nombreServicio')?.touched" class="text-danger">
              <i class="bi bi-exclamation-circle"></i> 
              El nombre del servicio es requerido (mínimo 3 caracteres)
            </div>
          </div>
          
          <div class="rs-col">
            <label class="form-label-xl">¿A qué categoría pertenece?</label>
            
            <div class="category-grid">
              <div 
                *ngFor="let c of categorias" 
                class="category-card" 
                [class.selected]="form.get('categoria')?.value == c.idCategoriaServicio"
                (click)="selectCategory(c.idCategoriaServicio)"
              >
                <i class="bi" [ngClass]="getCategoryIcon(c.nombre)"></i>
                <span>{{ c.nombre }}</span>
              </div>
            </div>

            <div *ngIf="cargandoCategorias" class="text-muted">Cargando categorías disponibles...</div>
            <div *ngIf="form.get('categoria')?.invalid && form.get('categoria')?.touched" class="text-danger mt-2">
              <i class="bi bi-exclamation-circle"></i> 
              Debes seleccionar una categoría
            </div>
          </div>
        </div>
      </section>

      <!-- PASO 2: Detalles del Servicio -->
      <section *ngIf="currentStep === 2" class="rs-section">
        <h2 class="rs-section-title">
          <i class="bi bi-list-check"></i>
          Detalles de tu Servicio
        </h2>
        
        <div class="rs-row">
          <!-- Columna Izquierda: Input y Tags -->
          <div class="rs-col-wide">
            <label for="descripcion" class="form-label-xl">Describe tu servicio en detalle</label>
            
            <!-- Etiquetas rápidas -->
            <div class="quick-tags-container">
              <span class="quick-tags-label"><i class="bi bi-magic"></i> Frases rápidas (clic para agregar):</span>
              <div class="quick-tags-list">
                <button 
                  *ngFor="let tag of quickTags" 
                  type="button" 
                  class="tag-btn" 
                  (click)="addTag(tag)"
                >
                  + {{ tag }}
                </button>
              </div>
            </div>

            <textarea
              class="form-control-xl rs-textarea-xl"
              id="descripcion"
              formControlName="descripcion"
              placeholder="Explica qué incluye tu servicio, materiales que usas, tiempo que tomas, precios por diferentes tamaños, etc."
            ></textarea>
            
            <div class="rs-char-counter">
              {{ (form.value.descripcion?.length || 0) }} caracteres escritos
              <br><small>Recomendamos escribir entre 120-300 caracteres para una mejor descripción</small>
            </div>
            
            <div *ngIf="form.get('descripcion')?.invalid && form.get('descripcion')?.touched" class="text-danger">
              <i class="bi bi-exclamation-circle"></i> 
              La descripción es requerida (mínimo 10 caracteres)
            </div>
          </div>

          <!-- Columna Derecha: Consejos (Sticky si es posible) -->
          <div class="rs-col-narrow">
            <div class="rs-tip-card">
              <div class="rs-tip-header">
                <i class="bi bi-lightbulb-fill"></i>
                <h3>Consejos Útiles</h3>
              </div>
              <div class="rs-tip-body">
                <ul class="rs-tip-check-list">
                  <li><i class="bi bi-check2-circle"></i> Usa palabras simples</li>
                  <li><i class="bi bi-check2-circle"></i> Menciona precios base</li>
                  <li><i class="bi bi-check2-circle"></i> ¿Incluyes materiales?</li>
                  <li><i class="bi bi-check2-circle"></i> Tu zona de atención</li>
                </ul>
                
                <div class="rs-example-box">
                  <strong>Ejemplo:</strong>
                  <p>"Realizo limpieza profunda de alfombras a domicilio. Uso productos hipoalergénicos. Precio desde $25.000 por habitación estándar."</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PASO 3: Imágenes y Ubicación -->
      <section *ngIf="currentStep === 3" class="rs-section">
        <h2 class="rs-section-title">
          <i class="bi bi-image"></i>
          Imágenes y Ubicación
        </h2>
        
        <div class="rs-row">
          <div class="rs-col">
            <label for="ubicacion" class="form-label-xl">¿Dónde prestas tu servicio?</label>
            <input
              type="text"
              class="form-control-xl"
              id="ubicacion"
              formControlName="direccionDescripcion"
              readonly
              style="background-color: #e9ecef; cursor: not-allowed;"
            />
            <small class="text-muted">
              <i class="bi bi-lock-fill"></i> 
              La ubicación se obtiene de tu perfil registrado. 
              <a routerLink="/perfil" style="color: #005A9C; text-decoration: underline;">Ir a mi perfil para editar</a>
            </small>
          </div>
          
          <div class="rs-col">
            <label class="form-label-xl">Fotos de tu trabajo</label>
            
            <div class="upload-zone" (click)="fileInput.click()">
              <i class="bi bi-cloud-arrow-up-fill"></i>
              <p>Haz clic aquí para subir fotos</p>
              <small>Puedes subir hasta 5 fotos (JPG, PNG)</small>
              <input
                #fileInput
                type="file"
                id="imagenes"
                multiple
                accept="image/*"
                (change)="onFileSelected($event)"
                style="display: none;"
              />
            </div>
            
            <div *ngIf="selectedFiles.length > 0" class="image-preview-grid">
              <div *ngFor="let file of selectedFiles; let i = index" class="preview-thumbnail">
                <div class="preview-icon"><i class="bi bi-image"></i></div>
                <div class="preview-info">
                  <span class="preview-name">{{ file.name }}</span>
                  <span class="preview-size">{{ (file.size / 1024 / 1024).toFixed(2) }} MB</span>
                </div>
                <button type="button" class="remove-btn" (click)="removeFile(i)" title="Eliminar foto">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
        
        <!-- Navegación prominente -->
      <div class="rs-nav-wide">
        <button 
          type="button" 
          class="btn btn-secondary btn-xl" 
          (click)="prevStep()" 
          [disabled]="currentStep === 1"
        >
          <i class="bi bi-arrow-left"></i> Paso Anterior
        </button>
        
        <button 
          type="button" 
          class="btn btn-primary btn-xl" 
          (click)="nextStep()" 
          [disabled]="!isStepValid(currentStep)" 
          *ngIf="currentStep < totalSteps"
        >
          Siguiente Paso <i class="bi bi-arrow-right"></i>
        </button>
        
        <button 
          type="button" 
          class="btn btn-success btn-xl" 
          [disabled]="!form.valid" 
          *ngIf="currentStep === totalSteps"
          (click)="openConfirmModal()"
        >
          <i class="bi bi-check-circle"></i> Revisar y Publicar
        </button>
      </div>
      
    </form>
  </div>
</div>

<!-- Modal de Confirmación -->
<div class="rs-modal-overlay" *ngIf="showConfirmModal">
  <div class="rs-modal-content">
    <div class="rs-modal-header">
      <h3><i class="bi bi-clipboard-check"></i> Confirmar Publicación</h3>
      <button type="button" class="rs-close-btn" (click)="closeConfirmModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <div class="rs-modal-body">
      <p class="rs-modal-intro">
        Estás a un paso de publicar tu servicio. Por favor revisa que la información sea correcta:
      </p>
      
      <div class="rs-resumen-grid">
        <div class="rs-resumen-item">
          <div class="rs-ri-icon">
            <i class="bi bi-pencil-fill"></i>
          </div>
          <div class="rs-ri-content">
            <span class="rs-ri-label">Nombre del Servicio</span>
            <span class="rs-ri-value">{{ form.value.nombreServicio || 'No especificado' }}</span>
          </div>
        </div>
        
        <div class="rs-resumen-item">
          <div class="rs-ri-icon">
            <i class="bi bi-tag-fill"></i>
          </div>
          <div class="rs-ri-content">
            <span class="rs-ri-label">Categoría</span>
            <span class="rs-ri-value">{{ getCategoriaName(form.value.categoria) || 'No seleccionada' }}</span>
          </div>
        </div>
        
        <div class="rs-resumen-item full-width">
          <div class="rs-ri-icon">
            <i class="bi bi-file-text-fill"></i>
          </div>
          <div class="rs-ri-content">
            <span class="rs-ri-label">Descripción Detallada</span>
            <div class="desc-preview">
              {{ form.value.descripcion || 'Sin descripción' }}
            </div>
          </div>
        </div>
        
        <div class="rs-resumen-item">
          <div class="rs-ri-icon">
            <i class="bi bi-geo-alt-fill"></i>
          </div>
          <div class="rs-ri-content">
            <span class="rs-ri-label">Ubicación</span>
            <span class="rs-ri-value">{{ form.value.direccionDescripcion || 'No especificada' }}</span>
          </div>
        </div>
        
        <div class="rs-resumen-item">
          <div class="rs-ri-icon">
            <i class="bi bi-images"></i>
          </div>
          <div class="rs-ri-content">
            <span class="rs-ri-label">Galería</span>
            <span class="rs-ri-value">{{ selectedFiles.length }} imagen{{ selectedFiles.length !== 1 ? 'es' : '' }} seleccionada{{ selectedFiles.length !== 1 ? 's' : '' }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="rs-modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeConfirmModal()">
        Volver a editar
      </button>
      <button 
        type="button" 
        class="btn btn-success" 
        (click)="confirmAndSubmit()" 
        [disabled]="isSubmitting"
      >
        <span *ngIf="!isSubmitting">
          <i class="bi bi-check-lg"></i> Confirmar y Publicar
        </span>
        <span *ngIf="isSubmitting">
          <i class="bi bi-hourglass-split"></i> Publicando... {{ uploadProgress }}%
        </span>
      </button>
    </div>
  </div>
</div>